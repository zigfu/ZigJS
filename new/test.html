<html>
<head>
	<script src='zig.js'></script>


<script>

var radar;

function loaded() {
	radar = (function(parent, userClass) {
		var parentElement = parent;
		var users = [];

		function onnewuser(newUser) {
			var el = document.createElement('div');
			el.classList.add(userClass);
			users[newUser.id] = el;
			parentElement.appendChild(el);
		}

		function onlostuser(lostUser) {
			parentElement.removeChild(users[lostUser.id]);
			delete users[lostUser.id];
		}

		function ondataupdate(trackedUsers) {
			for (var userid in trackedUsers) {
				var currUser = trackedUsers[userid];
				var el = users[currUser.id];
				var pos = currUser.position;
				el.style.left = (((pos[0] / 4000) + 0.5) * parentElement.offsetWidth - (el.offsetWidth / 2)) + "px";
				el.style.top = ((pos[2] / 4000.0) * parentElement.offsetHeight - (el.offsetHeight / 2)) + "px";
			}				
		}

		return {
			onnewuser : onnewuser,
			onlostuser : onlostuser, 
			ondataupdate : ondataupdate,
		}
	}(document.getElementById("radar"), "user"));
}

document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false); 

function bindFaderToRange(fader, rangeElement) {
	fader.addEventListener('valuechange', function(f) { rangeElement.value=(f.value*100);} );
}

function bindFader2DToNub(fader2d, nub) {
	fader2d.addEventListener('valuechange', function(f) { positionInParent(nub, f.value[0], f.value[1]);});
}

function positionInParent(element, posX, posY) {
	element.style.left = (posX * element.parentNode.offsetWidth - (element.offsetWidth / 2)) + "px";
	element.style.top = (posY * element.parentNode.offsetHeight - (element.offsetHeight / 2)) + "px";
}

function ZigPluginLoaded() {
	zig.init(document.getElementById("ZigPlugin"));


	var fader = zig.controls.Fader(0, 300);
	//fader.addEventListener('valuechange', function(value) {console.log(value);});
	
	var pushdetector = zig.controls.PushDetector();
	pushdetector.addEventListener('push', function() { console.log('Push'); });
	pushdetector.addEventListener('release', function() { console.log('Release'); });
	pushdetector.addEventListener('click', function() { console.log('Click'); });

	var swipeDetector = zig.controls.SwipeDetector();
	swipeDetector.addEventListener('swipe', function(dir) { console.log('Swipe: ' + dir); });

	bindFaderToRange(swipeDetector.verticalFader, document.getElementById('swipeVert'));
	bindFaderToRange(swipeDetector.horizontalFader, document.getElementById('swipeHoriz'));
	
	var fader2d = zig.controls.Fader2D(300,250);
	var nub = document.getElementById('nub');
	//bindFader2DToNub(fader2d, nub);

	var cursor = zig.controls.Cursor();
	cursor.addEventListener('move', function(c) {
		positionInParent(nub, c.value[0], c.value[1]);
	});
	cursor.addEventListener('push', function(c) {
		nub.classList.add('pushed');
	});
	cursor.addEventListener('release', function(c) {
		nub.classList.remove('pushed');
	});

	var waveD = zig.controls.WaveDetector();
	waveD.addEventListener('wave', function(wd) {
		console.log('WAVE');
	});

	bindFaderToRange(waveD.fader, document.getElementById('waved'));

	/*var crap = zig.EngageUsersWithSkeleton(1);
	
	

	var hsd = zig.HandSessionDetector();
	hsd.addListener(fader);*/

	var crap = zig.EngageFirstUserInSession();
	crap.addListener(fader);
	crap.addListener(pushdetector);
	crap.addListener(swipeDetector);
	crap.addListener(cursor);
	crap.addListener(waveD)

	crap.addEventListener('userengaged', function(user) {
		console.log("User engaged");
		//user.addListener(hsd);
	});
	crap.addEventListener('userdisengaged', function(user) {
		console.log('User disengaged');
		//user.removeListener(hsd);
	});
	crap.addEventListener('allusersengaged', function(allUsers) {
		console.log('All users engaged: ' + allUsers.length);
	});

	crap.addEventListener('sessionstart', function(fp) {
		console.log("Session start");
		nub.style.display = 'block';
	});
	crap.addEventListener('sessionupdate', function(p) {
		//console.log("Update: " + p);
	})
	crap.addEventListener('sessionend', function() {
		console.log("Session end");
		nub.style.display = 'none';
	});

	zig.addListener(crap);

	//zig.addListener(radar);

	//zig.addEventListener('newuser', function(newUser) {})
}

</script>

<style>

#visualizer {
	display: block;
	position:relative;
	width:500px;
	height:500px;
	border:solid black 1px;
}

#nub {
	display: none;
	position:relative;
	width:30px;
	height:30px;
	background-color: blue;
}

#nub pushed {
	background-color: red;
}

</style>

</head>
<body>


<div id="radar"></div>

<div id="pluginContainer">
	<object id="ZigPlugin" type="application/x-zig" width="0" height="0">
		<param name="onload" value="ZigPluginLoaded" />
	</object>
</div> 

<input type='range' min="0" max="100" value="80" id='waved'></input>
<br>
<input type='range' min="0" max="100" value="80" id='swipeVert'></input>
<br>
<input type='range' min="0" max="100" value="80" id='swipeHoriz'></input>

<div id='visualizer'>
	<div id='nub'></div>
</div>

</body>
</html>