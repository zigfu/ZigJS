<html>
<head>
<title>Mobile Controller</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="viewport" content="width=device-width, user-scalable=no"/>

<link rel="stylesheet" type="text/css" href="controllerstyle.css" />

<script type="text/javascript" src="iscroll.js"></script> 

<script src="/socket.io/socket.io.js"></script>
<script src="/synclist-client.js"></script>
<script src="/zmote-client.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script src="js/jquery.ui.touch-punch.js"></script>
<link type="text/css" href="css/custom-theme/jquery-ui-1.8.16.custom.css" rel="Stylesheet" />

<script>

var screenTypes = {
    chooseScreen : "roomslist",
    homeScreen : "homescreen",
    pointerScreen : "pointerscreen",
}

function gotoScreen(screenType) {
    for (var screen in screenTypes) {
        document.getElementById(screenTypes[screen]).style.display = (screenTypes[screen] == screenType) ? "block" : "none";
    }
}

var pointerTypes = {
    motion : "motion",
    touch : "touchpad",
}

var roomlistScroller;
var zmoteController;
var currentPointerMode;

function setPointer(pointerType) {
    for (var pt in pointerTypes) {
        document.getElementById(pointerTypes[pt]).style.display = (pointerTypes[pt] == pointerType) ? "block" : "none";
    }

    if (pointerType == pointerTypes.motion) {
        currentPointerMode = zmote.cursorModes.motion;
    }
    if (pointerType == pointerTypes.touch) {
        currentPointerMode = zmote.cursorModes.touchpadrel;
    }
    if (undefined !== zmoteController) {
        zmoteController.cursormode = currentPointerMode;
    }
}

var roomslist;

// name stuff
var currentName = localStorage.getItem("currentName");
if (null == currentName) currentName = "[Guest]";

// location stuff
var currentLocation = {};
if (navigator.geolocation)
{
    navigator.geolocation.getCurrentPosition(gotLocation, noLocation);
}

function gotLocation(position) {
    currentLocation = position;
}

function noLocation() {
    // bummer
}

function loaded() {
    //preventDocScrolling();
    nameChanged(currentName);

    roomlistScroller = new iScroll('roomslistContainer');

    gotoScreen(screenTypes.chooseScreen);
    setPointer(pointerTypes.touch);

    socket = io.connect('http://'+document.location.hostname);

    socket.on('connect', function () {
        var qs = document.location.search;
        var roomid = qs.substr(1,qs.length);

        socket.emit('controllerConnected',{ id : roomid, name : currentName, location : currentLocation});

        roomslist = synclist.subscribe(socket, "roomslist");
        roomslist.bind(document.getElementById("roomslistList"), function(id, data) {
            var li = document.createElement('li');
            li.innerHTML = data.name;
            addClass(li, "touchable");
            li.addEventListener("click", function() { socket.emit('joinRoom',{id: id}); });
            return li;
        });
        roomslist.onadd = function() {
            roomlistScroller.refresh();
        }
    });

    socket.on('roomJoined', function(data) {
        // did it work?
        var success = data.success;
        if (success) {
            // start the zmote
            zmoteController = zmote.controller(socket, data.zmoteid);
            zmoteController.bindtouchpad("touchpad");
            zmoteController.cursormode = currentPointerMode;
            zmoteController.ondisconnected = function() {
                gotoScreen(screenTypes.chooseScreen);
            }

            // show the welcome screen
            gotoScreen(screenTypes.homeScreen);
        }
    });

    socket.on('tvDied', function(data) {
        window.location = "#inputRooms";
    });

    $("#sensitivitySlider").slider({
            orientation: "vertical",
            range: "min",
            min: 0,
            max: 100,
            value: 60
        });

    preventScrolling("touchpad");
    //preventScrolling("sensitivitySlider");

    //hides address bar
    setTimeout("window.scrollTo(0, 1)", 1000); 
}

function hasClass(ele,cls) {
    return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
    if (!hasClass(ele,cls)) ele.className += " "+cls;
}

function doPointer() {
    zmoteController.onconnected = function() {
        gotoScreen(screenTypes.pointerScreen);
    }
    zmoteController.start();   
}

function stopCursor() {
    zmoteController.stop();
    gotoScreen(screenTypes.homeScreen);
}


function preventScrolling(id) {
    var elem = document.getElementById(id);
    function stopScrolling( touchEvent ) { touchEvent.preventDefault(); }
    elem.addEventListener( 'touchstart' , stopScrolling , false );
    elem.addEventListener( 'touchmove' , stopScrolling , false );
}

function preventDocScrolling(id) {
    function stopScrolling( touchEvent ) { 
        if (undefined !== touchEvent.target && hasClass(touchEvent.target, "touchable")) {
            return;
        }
        touchEvent.preventDefault(); 
    }
    document.addEventListener( 'touchstart' , stopScrolling , false );
    document.addEventListener( 'touchmove' , stopScrolling , false );
}


function recalibrate() {
    zmoteController.recalibrate();    
}

function nameentry() {
    document.getElementById("currentUserName").style.display = "none";
    document.getElementById("currentUserNameInput").style.display = "block";
    document.getElementById("currentUserNameInput").focus();
}

function nameentrydone() {
    var newName = document.getElementById("currentUserNameInput").value;
    console.log("Name changed: " + newName);
    nameChanged(newName);
	socket.emit('rename',{ name : newName});
}

function nameChanged(newName) {
    currentName = newName;
    localStorage.setItem("currentName", currentName);
    document.getElementById("currentUserNameInput").value = currentName;
    document.getElementById("currentUserName").innerHTML = currentName;
    document.getElementById("currentUserName").style.display = "block";
    document.getElementById("currentUserNameInput").style.display = "none";
}

function recalibrate() {
    zmoteController.recalibrate();    
}

function sendToTV(command, data) {
    socket.emit('sendToTV', { command : command, data : data });
}

document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);


</script>
</head>

<body>
<div id="wrapper">

	<div class="header">
	
    	<div class="name">
            <div id="currentUserName" onclick="nameentry();"></div>
    		<input style="display:none; width: 320px; height: 30px; font-size: 20px;" type="text" placeholder="[Enter Name]" spellcheck="off" autocomplete="off" id="currentUserNameInput" name="currentUserNameInput" onchange="nameentrydone()"/>

    	</div>
    </div>

	<div id="roomslist" class="invisible">
        <h2>Host Screen List</h2>
        <div id="roomslistContainer">
            <div class="scroller">
		      <ul id="roomslistList">
		      </ul>
            </div>
        </div>
	</div>

	<div id="homescreen" class="invisible">
    <!--
		<div class="nowplaying">
			TODO: Now playing
		</div>
		<div class="playlist">
		<h1>playlist</h1>
		<ul>
			<li>LIST ITEM</li>
			<li>LIST ITEM</li>

		</ul>


		</div><-->
		<div class="cursor"><a href="javascript:doPointer()"><img src="mi/cursors.png"></a>
            <p>   Cursor</p>
        </div>

        <div class="qrcode">
            <div onclick="javascript:sendToTV('toggleQR');"><img src="mi/qrcode.png"></div>
            <p>QR Code</p>
        </div>

	</div>

	<div id="pointerscreen" class="invisible">
        	<div id="touchpad" class="invisible">
            
            </div>
            
            <div id="motion" class="invisible">
            
            	<div class="motionContainer">
            
                <div class="recal"><div id="calibrateButton" ontouchend="recalibrate()"><img src="mi/recalibrate.png" /></div></div>

				</div>
                        
            </div>
			
            <div class="controllerOptions">
            
            	<a href="javascript:setPointer(pointerTypes.motion)"><div class="pointer"><h2>Motion</h2></div></a>
                
                <a href="javascript:setPointer(pointerTypes.touch)"><div class="touchpad"><h2>Touchpad</h2></div></a>
            
            
            </div>
            
            <div id="sensitivitySlider"></div>

			<div class="closebutton">

                <a href="javascript:stopCursor()" class="css_button">BACK</a>

			</div>



	</div>

</div>
</body>

</html>