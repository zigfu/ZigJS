<html>
<head>

<link rel="stylesheet" type="text/css" href="style.css" />

<script type="text/javascript" src="iscroll.js"></script>

<script src="/socket.io/socket.io.js"></script> 
<script type="text/javascript" src="./qrcode_files/qrcode.js"></script>
<script type="text/javascript" src="./qrcode_files/qrcanvas.js"></script>


<script src="/synclist-client.js"></script>
<script src="/zmote-client.js"></script>

<script type="text/javascript">

var medialibraryScroller;
var playlistScroller;
var userlistScroller;
var playercontrolsScroller;
var socket;

var userlist;
var zmoteReceiver;

var currentName = localStorage.getItem("roomName");
if (null == currentName) currentName = "[TV]";	

var currentLocation = {};
if (navigator.geolocation)
{
	navigator.geolocation.getCurrentPosition(gotLocation, noLocation);
}

function gotLocation(position) {
	currentLocation = position;
}

function noLocation() {
	// bummer
}


function positionInParent(element, posX, posY) {
	element.style.left = (posX * element.parentNode.offsetWidth - (element.offsetWidth / 2)) + "px";
	element.style.top = (posY * element.parentNode.offsetHeight - (element.offsetHeight / 2)) + "px";
}

function loaded() {
	medialibraryScroller = new iScroll('medialibraryScroller');
	playlistScroller = new iScroll('playlistScroller');
	userlistScroller = new iScroll('userlistScroller');
	playercontrolsScroller = new iScroll('playercontrolsScroller');
	
	var uniqueid = Math.floor(Math.random() * 100000);
	
	
	//TODO: we may want this socket to default to zig.tv and not origin for remote connections notifying the tracker
	socket = io.connect('http://'+document.location.hostname);
	socket.on('connect', function () {
		socket.emit("startRoom", {id: uniqueid, name : currentName, location : currentLocation});
	});
		
	socket.on('roomStarted', function(data) {
		userlist = synclist.subscribe(socket, data.userlist);
		userlist.bind(document.getElementById('userlistList'), function(userid, userdata) {
			var li = document.createElement('li');
			li.innerHTML = userdata.name;
			return li;
		});
		userlist.onadd = function() { userlistScroller.refresh(); }
		userlist.onremove = function() { userlistScroller.refresh(); }
		userlist.onclear = function() { userlistScroller.refresh(); }

		zmoteReceiver = zmote.receiver(socket);
		zmoteReceiver.onconnect = function(clientid) { console.log("Zmote connected: " + clientid); };
		zmoteReceiver.ondisconnect = function() { console.log("Zmote disconnected"); };
		//zmoteReceiver.onorientation = function(a,b,g) { console.log("Orientation:" + a); };
		var thecursor = document.getElementById("realcursor")
		zmoteReceiver.oncursor = function(cursor) { return function(x,y) { positionInParent(cursor, x, y); }} (thecursor) ;
	});
	
	socket.on('userJoined', function (data) {
		window.location = "#";
	});
	socket.on('input', function (data) {
		document.getElementById('textinputhere').innerHTML = data['value'];
	});	
	
	roomurl = 'http://'+document.location.hostname+"/?" + uniqueid;
	append_qrcode(4,"qrcode",roomurl);
	document.getElementById("roomURL").innerHTML = '<h1><a href=\'JavaScript:newPopup("'+roomurl+'");\'>'+roomurl+'</a></h1>';
	console.log(roomurl);
	document.getElementById("qrModalDialog").addEventListener('click',function() {
		window.location = "#";
	});

	
	nameChanged(currentName);
	document.getElementById("roomNameInput").addEventListener('change',nameentrydone, false);

}

function nameentrydone() {
	var newName = document.getElementById("roomNameInput").value;
	console.log(newName);
	nameChanged(newName);
}

function nameChanged(newName) {
	currentName = newName;
	localStorage.setItem("roomName", currentName);
	document.getElementById("roomNameInput").value = currentName;
	socket.emit('setName', { name : currentName });
}	

function newPopup(url) {
	popupWindow = window.open(
		url,'popUpWindow','height=960,width=640,left=10,top=10,resizable=no,scrollbars=no,toolbar=no,menubar=no,location=no,directories=no,status=no')
}
document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);


 </script>

<style>

#realcursor {
	width : 28;
	height : 35;
	position:absolute;
	background-image : url("i/hand-pointer.png");
}

</style>

</head>
<body>
<div class="header">

<a href="#">
<img src="i/logo.png" />
</a>

</div>
<div id="contentwrapper">
	<div id="playercontrols" class="mylist">
		<div class="scrollerheader"><a href="#">Info</a></div>
		<div id="playercontrolsScroller" class="scrollerContainer">
			<div class="scroller">

			<div id="roomnameArea">
				<INPUT type="text" placeholder="[Enter TV Name]" spellcheck="off" autocomplete="off" id="roomNameInput" name="roomNameInput"/>
			</div>
			<ul>
	<li>
		<a href="#qrModalDialog"><img src="i/getqr.png"></a>
	</li>
		</ul>
		
			</div>
		</div>
	</div>

	<div id="playlist" class="mylist">
		<div class="scrollerheader"><a href="#">Playlist</a></div>
		<div id="playlistScroller" class="scrollerContainer">
			<div class="scroller">
				<ul id="playlistList">
				</ul> 
			</div>
			<div id="cursor" class="showinsession pushable"></div>
			<div id="cursorCenter" class="showinsession pushable"></div>
		</div>
	</div>

	<div id="medialibrary" class="mylist">
		<div class="scrollerheader"><a href="#">Media Library</a></div>
		<div id="medialibraryScroller" class="scrollerContainer">
			<div class="scroller">
				<ul id="medialibraryList">
				</ul> 
			</div>
			<div id="cursor" class="showinsession pushable"></div>
			<div id="cursorCenter" class="showinsession pushable"></div>
		</div>
	</div>



	<div id="userlist" class="mylist">
		<div class="scrollerheader"><a href="#">User list</a></div>
		<div id="userlistScroller" class="scrollerContainer">
			<div class="scroller">
				<ul id="userlistList">
					
				</ul> 
			</div>
			<div id="cursor" class="showinsession pushable"></div>
			<div id="cursorCenter" class="showinsession pushable"></div>
		</div>
	</div>
</div>

 <div id="qrModalDialog" class="divModalDialog">
        <div id="qrDialog">
            <h1>Scan in QR reader</h1>
			<div id="roomURL"></div>
			<div style="background-color : white; width: auto; margin : auto">
				<div id="qrcode"/></div>
			</div>
        </div>
</div>

<div id="realcursor" class="showinsession">

</div>
	
</body>
</html>