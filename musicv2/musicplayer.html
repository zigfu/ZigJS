<!-- saved from url=(0014)about:internet -->
<!-- mo'tw o'mercy -->
<html>
<head>

<link rel="stylesheet" type="text/css" href="style.css" />

<script type="text/javascript" src="js/iscroll.js"></script>

<script src="/socket.io/socket.io.js"></script> 
<script type="text/javascript" src="./qrcode_files/qrcode.js"></script>
<script type="text/javascript" src="./qrcode_files/qrcanvas.js"></script>
<script type="text/javascript" src="js/id3v2.js"></script>

<script src="/synclist-client.js"></script>
<script src="/zmote-client.js"></script>

<script type="text/javascript">

var medialibraryScroller;
var playlistScroller;
var userlistScroller;
var playercontrolsScroller;
var socket;
var player;
var medialist;
var userlist;
var zmoteReceiver;

var songs = {};

var tvCommands = {};
tvCommands.on = function(command, callback) {
	this[command] = callback;
}

var currentRoomName = localStorage.getItem("currentRoomName");
if (null == currentRoomName) currentRoomName = "[TV Name]";	

var currentLocation = {};
if (navigator.geolocation)
{
	navigator.geolocation.getCurrentPosition(gotLocation, noLocation);
}

function gotLocation(position) {
	currentLocation = position;
}

function noLocation() {
	// bummer
}

var lastCursor = {x : 0, y : 0};

function setCursor(element, xpx, ypx) {
	element.style.left = lastCursor.x + "px";
	element.style.top = lastCursor.y + "px";
}

function positionCursor(element, posX, posY) {
	lastCursor.x = (posX * element.parentNode.offsetWidth - (element.offsetWidth / 2));
	lastCursor.y = (posY * element.parentNode.offsetHeight - (element.offsetHeight / 2));
	setCursor(element, lastCursor.x, lastCursor.y);
}

function doClick()
{
	console.log("Doing the click");
}

function clamp(val, min, max) {
	if (val < min) return min;
	if (val > max) return max;
	return val;
}

function moveCursorBy(element, deltaX, deltaY) {
	lastCursor.x = clamp(lastCursor.x + deltaX, 0, element.parentNode.offsetWidth);
	lastCursor.y = clamp(lastCursor.y + deltaY, 0, element.parentNode.offsetHeight);

	setCursor(element, lastCursor.x, lastCursor.y);
}

function hasClass(ele,cls) {
    return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
    if (!hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
	if (hasClass(ele,cls)) {
    	var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
		ele.className=ele.className.replace(reg,' ');
	}
}

nowPlaying = undefined;

function playSong(songid) {
	// TODO: unhighlight previously playing song
	if (undefined !== nowPlaying) {
		removeClass(medialist.getElement(nowPlaying), "playing");
	}
	nowPlaying = songid;
	
	// get the song element
	var songElem = medialist.getElement(songid);
	addClass(songElem, "playing");

	// get the actual song
	var song = songs[songid];
	player.src = geturl(song);
	player.play();

}
function togglePlayPause() {
	if (player.paused) { 
		player.play();
	} else {
		player.pause();
	}
}
function playNext() {
	console.log("todo: play next");
}
function playPrev() {
	console.log("todo: play prev");
}

function loaded() {
	//document.documentElement.style.overflow = 'hidden';	 // firefox, chrome
	//document.body.scroll = "no";	// ie only
	player = document.getElementById("audioPlayer");

	medialibraryScroller = new iScroll('medialibraryScroller');
	//playlistScroller = new iScroll('playlistScroller');
	userlistScroller = new iScroll('userlistScroller');
	//playercontrolsScroller = new iScroll('playercontrolsScroller');
	
	var uniqueid = Math.floor(Math.random() * 100000);
	
	var thecursor = document.getElementById("realcursor");
	positionCursor(thecursor, 0.5, 0.5); 
	
	//TODO: we may want this socket to default to zig.tv and not origin for remote connections notifying the tracker
	socket = io.connect('http://'+document.location.hostname);
	socket.on('connect', function () {
		socket.emit("startRoom", {id: uniqueid, name : currentRoomName, location : currentLocation});
	});
		
	socket.on('pingTV',function(data){
		socket.emit('pongTV',data);
	});
		
	socket.on('roomStarted', function(data) {
		// userlist
		userlist = synclist.subscribe(socket, data.userlist);
		userlist.bind(document.getElementById('userlistList'), function(userid, userdata) {
			var li = document.createElement('li');
			li.innerHTML = userdata.name;
			return li;
		});
		userlist.onadd = function() { userlistScroller.refresh(); }
		userlist.onremove = function() { userlistScroller.refresh(); }
		userlist.onclear = function() { userlistScroller.refresh(); }

		// media list
		medialist = synclist.subscribe(socket, data.medialist);
		medialist.bind(document.getElementById('medialibraryList'), function(songid, songdata) {
			var li = document.createElement('li');
			li.innerHTML = songdata.name;
			li.addEventListener("click", function() { playSong(songid) });
			return li;
		});
		medialist.onadd = function() { medialibraryScroller.refresh(); }
		medialist.onremove = function() { medialibraryScroller.refresh(); }
		medialist.onclear = function() { medialibraryScroller.refresh(); }

		// zmote stuff
		zmoteReceiver = zmote.receiver(socket);
		zmoteReceiver.onconnect = function(clientid) { console.log("Zmote connected: " + clientid); };
		zmoteReceiver.ondisconnect = function() { console.log("Zmote disconnected"); };
		var thecursor = document.getElementById("realcursor")
		zmoteReceiver.oncursor = function(cursor) { 
			return function(x,y, rel) { 
				if (rel) {
					moveCursorBy(cursor, x, y);
				} else {
					positionCursor(cursor, x, y); 
				}
			}
		} (thecursor) ;
		zmoteReceiver.onclick = doClick;
	});
	
	socket.on('userJoined', function (data) {
		window.location = "#";
	});

	socket.on('input', function (data) {
		document.getElementById('textinputhere').innerHTML = data['value'];
	});	

	tvCommands.on('toggleQR', function(data) {
		if (window.location.hash != "#qrModalDialog") {
			window.location = "#qrModalDialog";
		} else {
			window.location = "#";
		}
	});

	tvCommands.on('playSong', function(data) {
		playSong(data.songid);
	});

	tvCommands.on('togglePlayPause', function(data) {
		togglePlayPause();
	});
	tvCommands.on('playPrev', function(data) {
		playPrev();
	});
	tvCommands.on('playNext', function(data) {
		playNext();
	});
	tvCommands.on('setVolume', function(data) {
		var vol = data.volume;
		if (vol !== undefined) {
			player.volume = vol;
		}
	});

	socket.on('sendToTV', function(data) {
		// TODO: make sure command exists
		tvCommands[data.command](data.data);
	});

	roomurl = 'http://'+document.location.hostname+"/?" + uniqueid;
	append_qrcode(4,"qrcode",roomurl);
	document.getElementById("roomURL").innerHTML = '<h1><a href=\'JavaScript:newPopup("'+roomurl+'");\'>'+roomurl+'</a></h1>';
	document.getElementById("qrModalDialog").addEventListener('click',function() {
		window.location = "#";
	});

	
	nameChanged(currentRoomName);
	document.getElementById("currentRoomNameInput").addEventListener('change',nameentrydone, false);

	// Setup the dnd listeners.
	var dropZone = document.getElementById('medialibrary');
	dropZone.addEventListener('dragover', handleDragOver, false);
	dropZone.addEventListener('drop', handleFileSelect, false);
}

function parseFile(file, callback){
        //if(localStorage[file.fileName]) return callback(JSON.parse(localStorage[file.fileName]));
		console.log("Parsing " + file.fileName);
        ID3v2.parseFile(file,function(tags){
          //to not overflow localstorage
          localStorage[file.fileName] = JSON.stringify({
            Title: tags.Title,
            Artist: tags.Artist,
            Album: tags.Album,
            Genre: tags.Genre
          });
          callback(tags);
        });
      }

  function handleFileSelect(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    files = evt.dataTransfer.files;
	getSongs(files);
  }

  function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
  }

var lastSongId = 0;
function getNextSongId() {
	lastSongId++;
	return lastSongId;
}

function canPlay(type){
        var a = document.createElement('audio');
        return !!(a.canPlayType && a.canPlayType(type).replace(/no/, ''));
      }
  

function geturl(f) {
	var url;
    if(window.createObjectURL){
	  url = window.createObjectURL(f)
	}else if(window.createBlobURL){
	  url = window.createBlobURL(f)
	}else if(window.URL && window.URL.createObjectURL){
	  url = window.URL.createObjectURL(f)
	}else if(window.webkitURL && window.webkitURL.createObjectURL){
	  url = window.webkitURL.createObjectURL(f)
	}
	return url;
  }

  	function getSongs(files){
        var queue = [];
        var mp3 = canPlay('audio/mpeg;'), ogg = canPlay('audio/ogg; codecs="vorbis"');
        
		for(var i = 0; i < files.length; i++) {
			var file = files[i];
			var path = file.webkitRelativePath || file.mozFullPath || file.fileName;
			if (path.indexOf('.AppleDouble') != -1) {
				// Meta-data folder on Apple file systems, skip
				continue;
			}         
	  
			var size = file.size || file.fileSize || 4096;
			if(size < 4095) { 
				// Most probably not a real MP3
				continue;
			}
 
			if(file.fileName.indexOf('mp3') != -1) {
				if(mp3) {
					queue.push(file);
				}
			}
          
			if(file.fileName.indexOf('ogg') != -1  || file.fileName.indexOf('oga') != -1){
				if(ogg){
					queue.push(file);
				}
			}
        }
	
		var process = function() {
          if(queue.length){
            
            var f = queue.shift();
			var t2 = guessSong(f.webkitRelativePath || f.mozFullPath || f.fileName);
			
            parseFile(f,function(tags){
            	var theid = getNextSongId();
            	songs[theid] = f;
            	medialist.add({name : tags.Title}, theid);			  //$("#thelist").append($("<li>").text(t2.Title));
			});
						
            var lq = queue.length;
            setTimeout(function(){
              if(queue.length == lq){
                process();
              }
            },300);
          }
        }
        process();
	}


function nameentry() {
    document.getElementById("currentRoomName").style.display = "none";
    document.getElementById("currentRoomNameInput").style.display = "block";
    document.getElementById("currentRoomNameInput").focus();
}

function nameentrydone() {
    var newName = document.getElementById("currentRoomNameInput").value;
    console.log("Name changed: " + newName);
    nameChanged(newName);
	socket.emit('setName',{ name : newName});
}

function nameChanged(newName) {
    currentRoomName = newName;
    localStorage.setItem("currentRoomName", currentRoomName);
    document.getElementById("currentRoomNameInput").value = currentRoomName;
    document.getElementById("currentRoomName").innerHTML = currentRoomName;
    document.getElementById("currentRoomName").style.display = "block";
    document.getElementById("currentRoomNameInput").style.display = "none";
}

function newPopup(url) {
	popupWindow = window.open(
		url,'popUpWindow','height=960,width=640,left=10,top=10,resizable=no,scrollbars=no,toolbar=no,menubar=no,location=no,directories=no,status=no')
}
document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);


 </script>

<style>

#realcursor {
	width : 28;
	height : 35;
	position:absolute;
	background-image : url("i/hand-pointer.png");
}

</style>

</head>
<body>


<div id="contentwrapper">

	<div class="header">

		<a href="#" style="float : left">
			<img src="i/logo.png" />
		</a>

		<a href="#qrModalDialog" style="float : right"><img src="i/qrcode_small.png"></a>

		<!--
		<div id="roomnameArea" style="float : right">
			<INPUT type="text" style="float : right" placeholder="[Enter TV Name]" spellcheck="off" autocomplete="off" id="roomNameInput" name="roomNameInput"/>
		</div>
		-->
		<div style="float : right; width:320px">
			<div id="currentRoomName" onclick="nameentry();" class="nameentry">Test</div>

    		<input class="nameentry" style="display:none; " type="text" placeholder="[Enter TV Name]" spellcheck="off" autocomplete="off" id="currentRoomNameInput" name="currentRoomNameInput" onchange="nameentrydone()"/>
    	</div>

		

	</div>


	<div id="playercontrols" class="horizontalList">
		<div >
			<ul>
                <li> <img src="musicicons/MCPrev.png" onclick="javascript:playPrev();">
                </li>
                <li> <img src="musicicons/MCPlay.png" onclick="javascript:togglePlayPause();">
                </li>
                <li> <img src="musicicons/MCNext.png" onclick="javascript:playNext();">
                </li>
            </ul>
          </div>
	</div>
<!--
	<div id="playlist" class="mylist">
		<div class="scrollerheader"><a href="#">Playlist</a></div>
		<div id="playlistScroller" class="scrollerContainer">
			<div class="scroller">
				<ul id="playlistList">
				</ul> 
			</div>
			<div id="cursor" class="showinsession pushable"></div>
			<div id="cursorCenter" class="showinsession pushable"></div>
		</div>
	</div>
-->
	<div id="medialibrary" class="mylist">
		<div class="scrollerheader"><a href="#">Media Library</a></div>
		<div id="medialibraryScroller" class="scrollerContainer">
			<div class="scroller">
				<ul id="medialibraryList">
				</ul> 
			</div>
			<div id="cursor" class="showinsession pushable"></div>
			<div id="cursorCenter" class="showinsession pushable"></div>
		</div>
	</div>



	<div id="userlist" class="mylist">
		<div class="scrollerheader"><a href="#">User list</a></div>
		<div id="userlistScroller" class="scrollerContainer">
			<div class="scroller">
				<ul id="userlistList">
					
				</ul> 
			</div>
			<div id="cursor" class="showinsession pushable"></div>
			<div id="cursorCenter" class="showinsession pushable"></div>
		</div>
	</div>
</div>

 <div id="qrModalDialog" class="divModalDialog">
        <div id="qrDialog">
            <h1>Scan in QR reader</h1>
			<div id="roomURL"></div>
			<div style="background-color : white; width: auto; margin : auto">
				<div id="qrcode"/></div>
			</div>
        </div>
</div>

<div id="realcursor" class="showinsession">

</div>
<audio id="audioPlayer">
</body>
</html>