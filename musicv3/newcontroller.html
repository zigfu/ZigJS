<html>
<head>
<title>Mobile Controller</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="viewport" content="width=device-width, user-scalable=no"/>

<link rel="stylesheet" type="text/css" href="controllerstyle.css" />

<script type="text/javascript" src="js/iscroll.js"></script> 

<script src="/socket.io/socket.io.js"></script>
<script src="/synclist-client.js"></script>
<script src="/zigmote-client.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script src="js/jquery.ui.touch-punch.min.js"></script>
<link type="text/css" href="css/custom-theme/jquery-ui-1.8.16.custom.css" rel="Stylesheet" />

<script>

var screenTypes = {
    chooseScreen : "roomslist",
    homeScreen : "homescreen",
    pointerScreen : "pointerscreen",
    musicScreen : "musiclist",
}

function gotoScreen(screenType) {
    for (var screen in screenTypes) {
        document.getElementById(screenTypes[screen]).style.display = (screenTypes[screen] == screenType) ? "block" : "none";
    }

    showNavBar(screenType != screenTypes.chooseScreen);
}

function showNavBar(show) {
    document.getElementById("navBar").style.display = (show) ? "block" : "none";
}

var pointerTypes = {
    motion : "motion",
    touch : "touchpad",
}

var roomlistScroller;
var musiclistScroller;

var zmoteController;
var currentPointerMode;

function setPointer(pointerType) {
    //TODO
    /*
    for (var pt in pointerTypes) {
        document.getElementById(pointerTypes[pt]).style.display = (pointerTypes[pt] == pointerType) ? "block" : "none";
    }

    if (pointerType == pointerTypes.motion) {
        currentPointerMode = zmote.cursorModes.motion;
    }
    if (pointerType == pointerTypes.touch) {
        currentPointerMode = zmote.cursorModes.touchpadrel;
    }
    if (undefined !== zmoteController) {
        zmoteController.cursormode = currentPointerMode;
    }*/
}
var controller;
var roomslist;
var musicSyncList;

// name stuff
var currentName = localStorage.getItem("currentName");
if (null == currentName) currentName = "[Guest]";

// location stuff
var currentLocation = {};
if (navigator.geolocation)
{
    navigator.geolocation.getCurrentPosition(gotLocation, noLocation);
}

function gotLocation(position) {
    currentLocation = position;
}

function noLocation() {
    // bummer
}

function loaded() {
    //preventDocScrolling();
    nameChanged(currentName);

    roomlistScroller = new iScroll('roomslistContainer');
    musiclistScroller = new iScroll('musiclistContainer');

    gotoScreen(screenTypes.chooseScreen);
    setPointer(pointerTypes.touch);

    function roomJoinedOK(data) {
        // connect the music list
        //musicSyncList = synclist.subscribe(socket, data.medialist);
        musicSyncList = synclist.subscribe(socket, undefined); //TODO: HACK
        musicSyncList.bind(document.getElementById("musiclistList"), function(id, data){
            var li = document.createElement('li');
            li.innerHTML = data.name;
            addClass(li, "touchable");
            li.addEventListener("click", function() { sendToTV('playSong', {songid: id}); });
            return li;
        });
        musicSyncList.onadd = function() { musiclistScroller.refresh(); }

        // start the zmote
        //TODO:!!!
        /*
        zmoteController = zigmote.controller(socket, data.zmoteid);
        zmoteController.bindtouchpad("touchpad");
        zmoteController.bindtouchpad("motion");
        zmoteController.cursormode = currentPointerMode;
        zmoteController.ondisconnected = function() {
            gotoScreen(screenTypes.chooseScreen);
        }*/

        // show the welcome screen
        gotoScreen(screenTypes.homeScreen);
    }

    socket = io.connect('http://'+document.location.hostname);

    socket.on('connect', function () {
        var qs = document.location.search;
        var roomid = qs.substr(1,qs.length);

        socket.emit('controllerConnected',{ id : roomid, name : currentName, location : currentLocation});

        roomslist = synclist.subscribe(socket, zigmote.roomslistid);
        roomslist.bind(document.getElementById("roomslistList"), function(id, data) {
            var li = document.createElement('li');
            li.innerHTML = data.roomname;
            addClass(li, "touchable");
            li.addEventListener("click", function() { 
                controller = zigmote.controller(socket);
                controller.joinRoom(id, currentName, roomJoinedOK,
                        function(){console.log('join failed for room: ' + data.name);}); 
            });
            return li;
        });
        roomslist.onadd = function() {
            roomlistScroller.refresh();
        }
    });


    //TODO: refactor to use controller.onHostGone
    socket.on('zigmote-onHostGone', function(data) {
        gotoScreen(screenTypes.chooseScreen);
    });

    $("#sensitivitySlider").slider({
            orientation: "vertical",
            range: "min",
            min: 0,
            max: 100,
            value: 60
        });

    $("#thebutton").click(function() {
		$("#volumeSlider").toggle("slide", { direction: "up" }, 300);
	})

	$("#volumeSlider").slider({
            orientation: "vertical",
            range: "min",
            min: 0,
            max: 100,
            value: 60,
            start : function(event, ui) { 
	            $("#volumeLabel")
	            	.show("fade");
				$(ui.handle).attr("data-updateTimer", setInterval(function() {
						sendToTV("setVolume", {volume: ($("#volumeSlider").slider("option", "value") / 100)});
					}, 300));
	            },
            slide : function(event, ui) { 
	            $("#volumeLabel")
	            	.text(ui.value)
	            	.position({
            			my : "right center",
            			at : "left center",
            			of : ui.handle,
            			offset : "-10 3.5"}); 
	        	},
            stop : function(event, ui) { 
				$("#volumeLabel").hide("fade");
				$("#volumeSlider").hide("fade"); 
				clearInterval($(ui.handle).attr("data-updateTimer"));
				sendToTV("setVolume", {volume: (ui.value / 100)});
				}
        });

    preventScrolling("touchpad");
    preventScrolling("motion");
    //preventScrolling("sensitivitySlider");

    //hides address bar
    setTimeout("window.scrollTo(0, 1)", 1000); 
}

function hasClass(ele,cls) {
    return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
    if (!hasClass(ele,cls)) ele.className += " "+cls;
}

function doPointer() {
    zmoteController.onconnected = function() {
        gotoScreen(screenTypes.pointerScreen);
    }
    zmoteController.start();   
}

function stopCursor() {
    zmoteController.stop();
    gotoScreen(screenTypes.homeScreen);
}


function preventScrolling(id) {
    var elem = document.getElementById(id);
    function stopScrolling( touchEvent ) { touchEvent.preventDefault(); }
    elem.addEventListener( 'touchstart' , stopScrolling , false );
    elem.addEventListener( 'touchmove' , stopScrolling , false );
}

function preventDocScrolling(id) {
    function stopScrolling( touchEvent ) { 
        if (undefined !== touchEvent.target && hasClass(touchEvent.target, "touchable")) {
            return;
        }
        touchEvent.preventDefault(); 
    }
    document.addEventListener( 'touchstart' , stopScrolling , false );
    document.addEventListener( 'touchmove' , stopScrolling , false );
}


function recalibrate() {
    zmoteController.recalibrate();    
}

function nameentry() {
    document.getElementById("currentUserName").style.display = "none";
    document.getElementById("currentUserNameInput").style.display = "block";
    document.getElementById("currentUserNameInput").focus();
}

function nameentrydone() {
    var newName = document.getElementById("currentUserNameInput").value;
    console.log("Name changed: " + newName);
    nameChanged(newName);
	socket.emit('rename',{ name : newName});
}

function nameChanged(newName) {
    currentName = newName;
    localStorage.setItem("currentName", currentName);
    document.getElementById("currentUserNameInput").value = currentName;
    document.getElementById("currentUserName").innerHTML = currentName;
    document.getElementById("currentUserName").style.display = "block";
    document.getElementById("currentUserNameInput").style.display = "none";
}

function recalibrate() {
    zmoteController.recalibrate();    
}

function sendToTV(command, data) {
    controller.sendToHost(command, data);
}

document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);


</script>

</head>

<body>
<div id="wrapper">

	<div class="header">
    	<div class="name">
            <div id="currentUserName" onClick="nameentry();"></div>
    		<input style="display:none; width: 220px; height: 30px; font-size: 20px;" type="text" placeholder="[Enter Name]" spellcheck="off" autocomplete="off" id="currentUserNameInput" name="currentUserNameInput" onchange="nameentrydone()"/>

    	</div>
    </div>

	<div id="navBar" class="navBar">
    
    <a href="/"><img src="mi/controller/home.png" /></a>
    
    <ul>
    
    	<li><img src="mi/controller/mu_back.png" onClick="javascript:sendToTV('playPrev');" /></li>
        
        <li><img src="mi/controller/mu_play.png" onClick="javascript:sendToTV('togglePlayPause');" /></li>
        
        <li class="pp"><img src="mi/controller/mu_pause.png" /></li>
        
        <li><img src="mi/controller/mu_forward.png" onClick="javascript:sendToTV('playNext');" /></li>
        
    </ul>
            <img id="thebutton" src="mi/controller/mu_volume.png" /><div id="volumeSlider"></div><div id="volumeLabel"></div>
    </div>

	<div id="roomslist" class="invisible">
        <h2 class="coollistHeader">Host Screen List</h2>
        <div id="roomslistContainer" class="coollist">
            <div class="scroller">
		      <ul id="roomslistList">
		      </ul>
            </div>
        </div>
	</div>

<div id="homescreen" class="invisible">       
        
		<div class="homeScreenIcon">
        
            <a href="javascript:doPointer()"><img width="200px" height="200px" src="mi/cursors.png" /></a>

            <a href="javascript:sendToTV('toggleQR');"><img width="200px" height="200px" src="mi/qrcode.png" /></a>

            <a href="javascript:(function(){gotoScreen(screenTypes.musicScreen); musiclistScroller.refresh();})()"><img width="200px" height="200px" src="mi/music.png" /></a>
 
          
        </div>
		
        
	</div>

	<div id="pointerscreen" class="invisible">
        	<div id="touchpad" class="invisible">
            
            </div>
            
            <div id="motion" class="invisible">
            
            	<div id="motionContainer" class="motionContainer">
            
                    <div class="recal"><div id="calibrateButton" ontouchend="recalibrate()"><img src="mi/recalibrate.png" /></div></div>

				</div>
                        
            </div>
			
            <div class="controllerOptions">
            
            	<a href="javascript:setPointer(pointerTypes.motion)"><div class="pointer"><h2>Motion</h2></div></a>
                
                <a href="javascript:setPointer(pointerTypes.touch)"><div class="touchpad"><h2>Touchpad</h2></div></a>
            
            
            </div>
            
            <div id="sensitivitySlider"></div>

			<div class="closebutton">

            <a href="javascript:stopCursor()" class="css_button">BACK</a>

			</div>

	</div>

    <div id="musiclist" class="invisible">
        <h2 class="coollistHeader">Music</h2>
        <div id="musiclistContainer" class="coollist">
            <div>
              <ul id="musiclistList">
              </ul>
            </div>
        </div>

        <div class="closebutton">

            <a href="javascript:stopCursor()" class="css_button">BACK</a>

        </div>

    </div>

</div>
</body>

</html>