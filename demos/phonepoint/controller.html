<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name = "viewport" content = "width = device-width, initial-scale = 1.0, user-scalable = no"/>


<style>

.mylist {
	overflow: hidden;
	border:	3px solid darkblue;
	margin : 0 0;
	position : relative;
}

.scrollerContainer {
	width: 100%;
	height : 100%;
	margin: auto;
	overflow:hidden;
	position:relative;
}

.scroller ul {
	list-style:none;
	padding:0;
	margin:0;
	width:100%;
	text-align:left;
}

.scroller li {
	padding:0 10px;
	height:40px;
	line-height:40px;
	border-bottom:1px solid #ccc;
	border-top:1px solid #fff;
	background-color:#fafafa;
	font-size:24px;
}

.scrollerheader {
	width:100%;
	height:45px;
	line-height:45px;
	background-color:#d51875;
	background-image:-webkit-gradient(linear, 0 0, 0 100%, color-stop(0, #fe96c9), color-stop(0.05, #d51875), color-stop(1, #7b0a2e));
	background-image:-moz-linear-gradient(top, #fe96c9, #d51875 5%, #7b0a2e);
	background-image:-o-linear-gradient(top, #fe96c9, #d51875 5%, #7b0a2e);
	padding:0;
	color:#eee;
	font-size:20px;
	text-align:center;
}

.scrollerheader a {
	color:#f3f3f3;
	text-decoration:none;
	font-weight:bold;
	text-shadow:0 -1px 0 rgba(0,0,0,0.5);
}

#playercontrols {
	width : 65%;
	height : 15%;
	float : left;
}

#medialibrary {
	width : 65%;
	height : 75%;
	float : left;
}

#playlist {
	width : 30%;
	height : 55%; 
	float : right;
}

#userlist {
	width : 30%;
	height : 35%;
	float : right;
}

#roomlist {
	width : 100%;
	height : 70%;
	float : center;
}

#wrapper {
	height : 100%;
}

</style>



<script type="text/javascript" src="iscroll.js"></script> 
<script src="/socket.io/socket.io.js"></script>
<script src="/synclist-client.js"></script>
<script src="/zmote-client.js"></script>
<script>

var roomlistScroller;
var socket;
var roomslist;

var playlist;
var userlist;
var medialist;

var zmoteController;

document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);

var geolocation_support = false;
function $(id) { return document.getElementById(id); }

if (navigator.geolocation)
{
	geolocation_support = true;
	navigator.geolocation.getCurrentPosition(consoleLocation, noLocation);
}

function testRoundtrip()
{
	console.log("Testing round trip");
	socket.emit("echo", { timestamp : new Date().getTime() });
}

function runSearch(txt)
{
	console.log(txt);
}

function keypress(evt)
{
       var charCode = evt.which;
       var charStr = String.fromCharCode(charCode);
	   //$('console1').innerHTML = "keypress " + charStr + " cc: " + charCode;
	   anjou.emit('keypress',{charCode: evt.which});
}

function keydown(evt)
{
       var charCode = evt.which;
       var charStr = String.fromCharCode(charCode);
	  // $('console2').innerHTML = "keydown " + charStr + " cc: " + charCode;
	   
}

function keyup(evt)
{
       var charCode = evt.which;
       var charStr = String.fromCharCode(charCode);
	   //$('console3').innerHTML = "keyup " + charStr + " cc: " + charCode;
	   anjou.emit('keyup',{charCode: evt.which});
}

function textinput(evt)
{
	runSearch(evt.target.value);
	//$('console5').innerHTML = "oninput: " + evt.target.value;
	//console.log(evt);
	console.log('input: ' + evt.target.value);
	anjou.emit('input',{value: evt.target.value});
}

function positionInParent(element, posX, posY) {
	element.style.left = (posX * element.parentNode.offsetWidth - (element.offsetWidth / 2)) + "px";
	element.style.top = (posY * element.parentNode.offsetHeight - (element.offsetHeight / 2)) + "px";
}


var currentName = localStorage.getItem("currentName");
if (null == currentName) currentName = "[Guest]";	
var currentLocation = [];
	
	
function makegenericprinter(label) {
	function genericprinter(id, data) {
		if (undefined !== data) {
			console.log(label + ": " + "(" + id + ", " + data + ")");	
		} else {
			console.log(label + ": " + "(" + id + ")");	
		}
	}
	return genericprinter;
}

var max_zigtv = 0;
var max_tv = 0;
function loaded()
{
	roomlistScroller = new iScroll('roomlistScroller');
	nameChanged(currentName);
	
	$('search').addEventListener('keypress',keypress);		
	$('search').addEventListener('keydown',keydown);
	$('search').addEventListener('keyup',keyup);
	$('search').addEventListener('input', textinput);
	
	$('search').addEventListener("DOMNodeInserted", textinput, false);
$('search').addEventListener("DOMNodeRemoved", textinput, false);
$('search').addEventListener("DOMCharacterDataModified", textinput, false);



	if (geolocation_support)
	{
		navigator.geolocation.getCurrentPosition(consoleLocation, noLocation);
	}

	socket = io.connect('http://'+document.location.hostname);

	socket.on('connect', function () {
		var qs = document.location.search;
		var roomid = qs.substr(1,qs.length);

		socket.emit('controllerConnected',{ id : roomid, name : currentName, location : currentLocation});

		roomslist = synclist.subscribe(socket, "roomslist");
		roomslist.bind(document.getElementById("roomlistList"), function(id, data) {
			var li = document.createElement('li');
			li.innerHTML = data.name;
			li.addEventListener("click", function() { socket.emit('joinRoom',{id: id}); });
			return li;
		});


		socket.on('roomJoined', function(data) {
			// did it work?
			var success = data.success;
			if (success) {
				// hide room list
				document.getElementById("roomlist").style.display = "none";
				document.getElementById("touchsurface").style.display = "block";
				document.getElementById("errormsg").innerHTML = "Successfully joined!";

				// register to the room specific lists
				playlist = synclist.subscribe(socket, data.playlist);
				userlist = synclist.subscribe(socket, data.userlist);
				medialist = synclist.subscribe(socket, data.medialist);

				playlist.onadd = makegenericprinter("Add");
				playlist.onremove = makegenericprinter("Remove");
				playlist.onclear = makegenericprinter("Clear");

				userlist.onadd = makegenericprinter("Add");
				userlist.onremove = makegenericprinter("Remove");
				userlist.onclear = makegenericprinter("Clear");

				medialist.onadd = makegenericprinter("Add");
				medialist.onremove = makegenericprinter("Remove");
				medialist.onclear = makegenericprinter("Clear");

				// start the zmote
				zmoteController = zmote.controller(socket);
				//zmoteController.cursormode = zmote.cursorModes.motion;
				zmoteController.cursormode = zmote.cursorModes.motion;
				zmoteController.bindtouchpad("touchsurface");
				zmoteController.start(data.zmoteid);

			} else {
				document.getElementById("errormsg").innerHTML = data.error;
			}
		});
		
		socket.on('echofromzigtv', function(data){
				var now = new Date().getTime();
				var delta = now - data.timestamp;
				document.getElementById("touchsurface_ztv").innerHTML = delta + "";
				if (delta > max_zigtv)
				{
					max_zigtv = delta;
					document.getElementById("touchsurface_ztv_max").innerHTML = delta + "";
				}
			});
		socket.on('echofromtv', function(data){
				var now = new Date().getTime();
				var delta = now - data.timestamp;
				document.getElementById("touchsurface_tv").innerHTML = delta + "";
				if (delta > max_tv)
				{
					max_tv = delta;
					document.getElementById("touchsurface_tv_max").innerHTML = delta + "";
				}
			});
			setInterval("testRoundtrip()",500);
			
	});
}

function consoleLocation(position)
{  
	currentLocation = position;
	var lat = position.coords.latitude;
	var long = position.coords.longitude;
	//$('console4').style.backgroundColor="green";
	//$('console4').innerHTML = lat + " " +  long;
}


function noLocation()
{
  document.getElementById("console4").style.backgroundColor="red";
  //$("console4").innerHTML = "locationFail";
}
	
function reportLocation(position)
{
  var lat = position.coords.latitude;
  var long = position.coords.longitude;
  consoleLocation(position);
  anjou.emit('loc', {latitude: lat, longitude: long});
}
function sendLoc(){
	if (geolocation_support)
	{
		navigator.geolocation.getCurrentPosition(reportLocation, noLocation);
	}
}

function stopScrolling( touchEvent ) { touchEvent.preventDefault(); }
document.addEventListener( 'touchstart' , stopScrolling , false );
document.addEventListener( 'touchmove' , stopScrolling , false );
	

	function nameentrydone() {
		var newName = document.getElementById("currentUserNameInput").value;
		console.log(newName);
		nameChanged(newName);
	}
	

	
	function nameChanged(newName) {
		currentName = newName;
		localStorage.setItem("currentName", currentName);
		document.getElementById("currentUserNameInput").value = currentName;
		
	}	
	
function processRoom(key, metadata)
{
	li = document.createElement('li');
	li.innerHTML = metadata.name;
	li.addEventListener("click", function() { socket.emit('joinRoom',{id: key}); });
	document.getElementById('roomlistList').appendChild(li);
}


</script>



	<style>
	
	
	#currentUserNameInput {
		width: 100%;
	
	}
	#search {
		width: 100%;
	}
	
	#errormsg {
		color : red;
	}
	
	#touchsurface {
		display: none;
		background-color: #88FF88;
		width: 320px;
		height: 240px;
	}
	</style>
	

</head>
<body>
<div id="wrapper">
<div id="usernameArea">
	<input type="text" placeholder="[Guest]" spellcheck=off autocomplete=off id="currentUserNameInput" name="currentUserNameInput" onchange="nameentrydone();">
</div>

<input id="search" placeholder="text input" spellcheck=off autocomplete=off />
<br>
<div id="roomlist" class="mylist">
	<div class="scrollerheader"><a href="#">Room List</a></div>
	<div id="roomlistScroller" class="scrollerContainer">
		<div class="scroller">
			<ul id="roomlistList">
			</ul>
		</div>
	</div>
</div>
<div id="touchsurface">touchsurface<br>
<span id="touchsurface_ztv"></span> max: <span id="touchsurface_ztv_max"></span><br>
<span id="touchsurface_tv"></span> max: <span id="touchsurface_tv_max"></span>
</div>
<div id="errormsg"></div>

</div>	
</body>
</html>