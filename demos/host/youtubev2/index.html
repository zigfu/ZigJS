<!-- saved from url=(0013)http://zig.tv -->
<html>
  <head>

  <link href='css/style.css' rel='stylesheet' type='text/css' />

    <script src="/socket.io/socket.io.js"></script>
    <script src="../js/synclist-client.js"></script>
    <script src="../js/zigmote-client.js"></script>
    <script src="../js/zigmote.cursor.js"></script>
    <script src="../goto.js"></script>
    <script type="text/javascript" src="js/iscroll.js"></script>
    <script src="js/swfobject.js" type="text/javascript"></script> 

<style>
    #wrapper {
      width : 100%;
      height : 100%;
    }
    #cursor {
      width : 28px;
      height : 35px;
      position:absolute;
      background-image : url("img/hand-pointer.png");
    }
</style>
<script>

function hysteresis(classname, pixelsize, container) {
  var cls = classname;
  var size = pixelsize; //TODO: separate X, Y sizes?
  var items;
  var currentItem = null;

  if (undefined === container) {
    container = document.body;
  }

  function refreshItems() {
    items = document.getElementsByClassName(cls);
  }
  function start() {
    currentItem = null;
  }
  function stop() {
    if (currentItem) {
      currentItem.classList.remove("hovering");
    }
  }
  function inItem(item, x, y) {
    var rect = item.getBoundingClientRect();
    return (rect.left <= x) && (x <= rect.right) && (rect.top <= y) && (y <= rect.bottom);
  }
  function stillIn(item, x, y) {
    var rect = item.getBoundingClientRect();
    return ((rect.left-size) <= x) && (x <= (rect.right+size)) && ((rect.top-size) <= y) && (y <= (rect.bottom+size));
  }
  function updateNormalized(x,y) {
    update(container.offsetWidth * x, container.offsetHeight * y);
  }
  function update(x,y) {
    //TODO: something similar to jQuery .offset() instead - this can probably
    //      break in some ways I don't know when using borders, padding and margins
    var rect = container.getBoundingClientRect();
    x += rect.left;
    y += rect.top;
    if (currentItem) {
      if (stillIn(currentItem, x, y)) return;
      // we left the current item
      //TODO: not special case
      currentItem.classList.remove("hovering");
      currentItem = null;
    }
    for (var i = 0; i < items.length; i++) {
      if (inItem(items[i], x, y)) {
        currentItem = items[i];
        currentItem.classList.add("hovering");
        break;
      }
    }
  }

  return { refreshItems : refreshItems,
       start : start,
       stop : stop,
       update : update,
       updateNormalized : updateNormalized,
    };
}


</script>

<script>

var lastCursor = {x : 0, y : 0};

var cursorElement;

var pushed = false;

function setCursor(element, xpx, ypx) {
  element.style.left = xpx + "px";
  element.style.top = ypx + "px";
  videolisthysteresis.update(xpx, ypx);
  if (pushed) {
    iscrollMouseMove(videolistscroller, xpx, ypx);
  }
}


function positionCursor(element, posX, posY) {
  lastCursor.x = (posX * element.parentNode.offsetWidth - (element.offsetWidth / 2));
  lastCursor.y = (posY * element.parentNode.offsetHeight - (element.offsetHeight / 2));
  setCursor(element, lastCursor.x, lastCursor.y);
}

function doClick()
{
  console.log("Doing the click");
  x = parseInt(document.getElementById("realcursor").style.left);
  y = parseInt(document.getElementById("realcursor").style.top);
  elt = document.elementFromPoint(x,y-1); //subtract one to get the thing cursor points to
  var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("click", true, true, window, 1, x, y, x, y,
        false, false, false, false, 0, null);
  elt.dispatchEvent(evt);
}
function clamp(val, min, max) {
  if (val < min) return min;
  if (val > max) return max;
  return val;
}

function moveCursorBy(element, deltaX, deltaY) {
  lastCursor.x = clamp(lastCursor.x + deltaX, 0, element.parentNode.offsetWidth);
  lastCursor.y = clamp(lastCursor.y + deltaY, 0, element.parentNode.offsetHeight);

  setCursor(element, lastCursor.x, lastCursor.y);
}

function iscrollMouseMove(iscroll, x,y) {
  iscroll.handleEvent({
      type:"mousemove", 
      pageX : x, 
      pageY : y,
      });
}

function iscrollMouseDown(iscroll, x,y) {
  iscroll.handleEvent({
      type:"mousedown", 
      pageX : x, 
      pageY : y,
      button : 0,
      preventDefault : function() {} });
}

function iscrollMouseUp(iscroll, x,y) {
  iscroll.handleEvent({
      type:"mouseup", 
      pageX : x, 
      pageY : y,
      button : 0});
}


</script>


    <script>

var mainAreaTypes = {
  videolist : "videolistScroller",
  videoplayer : "playerContainer",
  novideos : "novideosparent",
}

function setMainArea(type) {
  for(var t in mainAreaTypes) if (mainAreaTypes.hasOwnProperty(t)) {
    var eid=mainAreaTypes[t];
    document.getElementById(eid).style.display = (type == mainAreaTypes[t]) ? "block" : "none";
  }

  document.getElementById('backbutton').style.display = (type == mainAreaTypes.videoplayer) ? "block" : "none";
}

function setTitle(t) {
  document.getElementById("title").innerHTML = t;
}

var currentRoomName = localStorage.getItem("currentRoomName");
if (null == currentRoomName) currentRoomName = "[ZigFu Demo]";  

function nameentry() {
    document.getElementById("currentRoomName").style.display = "none";
    document.getElementById("currentRoomNameInput").style.display = "block";
    document.getElementById("currentRoomNameInput").focus();
}

function nameentrydone() {
    var newName = document.getElementById("currentRoomNameInput").value;
    nameChanged(newName);
}

function nameChanged(newName) {
  if (newName == "") newName = "[NonameTV]";
    currentRoomName = newName;
    localStorage.setItem("currentRoomName", currentRoomName);
    document.getElementById("currentRoomNameInput").value = currentRoomName;
    document.getElementById("currentRoomName").innerHTML = currentRoomName;
    document.getElementById("currentRoomName").style.display = "block";
    document.getElementById("currentRoomNameInput").style.display = "none";
    if (undefined !== host) {
      host.rename(currentRoomName);
    }
}

function showModal(elementId) {
  document.getElementById('mask').style.display = 'block';
  document.getElementById(elementId).style.display = 'block';
}

function hideModal(e) {
  document.getElementById('mask').style.display = 'none';
  var dialogs = document.querySelectorAll(".modaldialog");
  for (var i=0; i<dialogs.length;i++) dialogs[i].style.display = 'none';
  if (undefined !== e) e.stopPropagation();
}

function youtubeSearchResult(result) {
  var data = result.data;
  console.log(result.data);
  for(var i = 0; i < data.items.length; i++) {
    videolist.add({title:data.items[i].title, videoid:data.items[i].id}, data.items[i].id);
  }
}

var lastQuery='';
function doyoutubeSearch(query) {
  lastQuery=query;
  videolist.clear();
  var s = document.createElement('script');
  s.src = "http://gdata.youtube.com/feeds/api/videos?v=2&alt=jsonc&callback=youtubeSearchResult&q=" + query;
  document.body.appendChild(s); //ajax it!
  setTitle("Results for: "+query);
  hideModal();
  videolistscroller.scrollTo(0,0);
  setMainArea(mainAreaTypes.videolist);
}

function doBack() {
  stopVideo();
  setMainArea(mainAreaTypes.videolist);
  setTitle('Results for: ' + lastQuery);
}

var socket;
var host;
var videolistscroller;
var videolist;
var videolisthysteresis;

function roomStarted(roomData) {
  videolist = synclist.subscribe(socket, roomData.roomid + ":videolist");
  videolist.clear();
  videolist.bind(document.getElementById('videolist'), function(id, data) {
    var l = document.createElement('li');
    l.innerHTML = data.title;
    l.classList.add('hoverable');
    l.addEventListener('click', function() {
      setTitle(data.title);
      setMainArea(mainAreaTypes.videoplayer);
      loadVideo(data.videoid);
    });
    return l;
  });
  videolist.onadd = function() { videolistscroller.refresh(); videolisthysteresis.refreshItems(); }

  host.on('doSearch', function(data) {
      doyoutubeSearch(data.query);
    });
  host.on('goto', function(data) { goto(data); });

  host.cursor.oncursorlock = function(userid) { 
    videolisthysteresis.start();
    cursorElement.style.display = 'block';
  }
  host.cursor.oncursorunlock = function() { 
    videolisthysteresis.stop(); 
    cursorElement.style.display = 'none';
  }
  host.cursor.onpushstart = function(userid) {
    pushed = true;
    iscrollMouseDown(videolistscroller, lastCursor.x, lastCursor.y);
  }
  host.cursor.onpushstop = function(userid) {
    pushed = false;
    iscrollMouseUp(videolistscroller, lastCursor.x, lastCursor.y);
  }
  host.cursor.oncursor = function(x,y,rel,userid) {
    //if (cursor_userid != userid) return;
    if (rel) {
      moveCursorBy(cursorElement,x,y);
    } else {
      positionCursor(cursorElement,x,y);
    }
  }

  var roomshared = synclist.subscribe(socket, roomData.roomsharedid);
  roomshared.set('hostpage', 'video');
}

function loaded() {
  nameChanged(currentRoomName);

  // connect to zigtv
  //socket = io.connect('http://zig.tv');
  socket = io.connect('http://'+document.location.hostname);
  socket.on('connect', function () {
    host = zigmote.host(socket);
    host.startRoom("motionosdemos", currentRoomName, roomStarted);
  });

  socket.on('disconnect', function() {
    console.log("Disconnected from zig.tv");
    // disconnected
  });

  videolistscroller = new iScroll('videolistScroller');


  document.getElementById('novideos').addEventListener('click', function() { showModal('searchbox');}, false);
  document.getElementById('searchbutton').addEventListener('click', function(e) { 
    doyoutubeSearch(document.getElementById('search').value);}, false);
   document.getElementById('mask').addEventListener('click', hideModal, false);
  //document.addEventListener('click', function() { showModal('searchbox');}, false);

  cursorElement = document.getElementById('cursor');
  videolisthysteresis = hysteresis("hoverable", 20, document.getElementById('videolistScroller'));

  loadPlayer("videoDiv", "100%", "100%");
  
}

document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);


    </script>

<script>

  var ytplayer;

    function loadPlayer(divid, width, height) {
      var so = new SWFObject("http://www.youtube.com/apiplayer?&enablejsapi=1&playerapiid=player1", "ytPlayer", width, height, '9.0', '#000000');
      so.addParam("allowscriptaccess", "always");
      so.write(divid);
    }

    function seek(position) {
      if ((position < 0) || (position > 1)) {
        return;
      } else {
        if (ytplayer) {
          var duration = ytplayer.getDuration();
          if (duration == 0) {
            return;
          }
          ytplayer.seekTo(duration*position, true);
        }
      }
    }
      

   function setVideoVolume(volume) {
        if(isNaN(volume) || volume < 0 || volume > 100) {
        }
        else if(ytplayer){
          ytplayer.setVolume(volume);
        }
      }
      
      function playVideo() {
        if (ytplayer) {
          ytplayer.playVideo();
        }
      }
      
      function pauseVideo() {
        if (ytplayer) {
          ytplayer.pauseVideo();
        }
      }

      function stopVideo() {
        if (ytplayer) {
          ytplayer.stopVideo();
        }
      }
      
      function muteVideo() {
        if(ytplayer) {
          ytplayer.mute();
        }
      }
      
      function unMuteVideo() {
        if(ytplayer) {
          ytplayer.unMute();
        }
      }
      

  function loadVideo(videoId)
  {
    if (ytplayer && undefined !== ytplayer.loadVideoById) {
      ytplayer.loadVideoById(videoId);
    } else {
      loadWhenDone = videoId;
    }
  }

      function onPlayerError(errorCode) {
        console.log("Youtube: An error occured of type:" + errorCode);
      }
      
      // This function is called when the player changes state
    playerState = 0;
      function onPlayerStateChange(newState) {
    playerState = newState;
      }
  
  loadWhenDone = undefined;
    function onYouTubePlayerReady(playerId) {
      console.log('youtube ready');
      ytplayer = document.getElementById("ytPlayer");
        ytplayer.addEventListener("onStateChange", "onPlayerStateChange");
        ytplayer.addEventListener("onError", "onPlayerError");
    if (undefined !== loadWhenDone) {
      loadVideo(loadWhenDone);
      loadWhenDone = undefined;
    }
  }

</script>

  </head>

  <body>

  <div id="wrapper">

    <div id='header'>
        <div class='row'>
          <div class='left'>
            <a href='../index.html'><img src='img/logo.png' alt='' /></a>
          </div>
          <div class='right'>
            <div style='float : right'>
              <h1 id="currentRoomName" onClick="nameentry();" class="nameentry">[Room Name]</h1>

                <input class="nameentry" style="display:none; margin-top: 20px; " type="text" placeholder="[Enter TV Name]" spellcheck="off" 
                autocomplete="off" id="currentRoomNameInput" name="currentRoomNameInput" onChange="nameentrydone()"/>
                
            </div>
          </div>
        </div>
      </div>

   <div id='gallery'> 
    <div id='title'>Youtube Player</div>
    <div id='mainarea'>

      <div id='novideosparent'><div id='novideos'>Click here to search</div></div>

      <div id='videolistScroller' style="display: none;">
        <ul id='videolist'></ul>
      </div>

      <div id='cursor' style='display: none;'></div>
      
      <div id="playerContainer" style="display: none;">
        <div id="videoDiv">Loading...</div>
      </div>

      <div id='backbutton' style='display: none;' onClick="doBack()"><p>BACK</p></div>

    </div>

     <div id='mask'></div>
     <div id='searchbox' class='modaldialog'>
        <div class='modaldialogcontents'>
          <input type='text' id='search' placeholder="Search YouTube!" /><div id='searchbutton'><p>Search</p></div>
        </div>
     </div>
   </div>
  </div>

  </body>
</html>