<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Zigfu // Showcase</title>

<link href='http://fonts.googleapis.com/css?family=Istok+Web:400,400italic,700,700italic|Abel|Yellowtail' rel='stylesheet' type='text/css' />

<link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css' />

<link rel="stylesheet" type="text/css" href="../css/style.css" />

<script src="zig.js"></script>
<script src="../goto.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="js/synclist-client.js"></script>
<script src="js/zigmote-client.js"></script>
<script src="js/zigmote.cursor.js"></script>


<script>
var codexStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
var codexInt = [];
for(var i = 0; i < 256; i++) {
  var idx = codexStr.indexOf(String.fromCharCode(i));
  codexInt[i] = idx;
}
var Base64 =
{
    // assuming that the input string encodes a number of bytes divisible by 3
    decode : function (input)
    {
        var output = new Array(input.length*3/4);
        var inLength = input.length;
        var outIndex = 0;
        for (var i = 0; i < inLength; i += 4) {
            var enc1 = codexInt[input.charCodeAt(i)];
            var enc2 = codexInt[input.charCodeAt(i+1)];
            var enc3 = codexInt[input.charCodeAt(i+2)];
            var enc4 = codexInt[input.charCodeAt(i+3)];

            var chr1 = (enc1 << 2) | (enc2 >> 4);
            var chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
            var chr3 = ((enc3 & 3) << 6) | enc4;
            

            output[outIndex] = chr1;
            output[outIndex+1] = chr2;
            output[outIndex+2] = chr3;
            outIndex += 3;
        }

        return output;
    }
}

function ZigPluginLoaded() {

    var pluginObj = document.getElementById("ZigPlugin");
    i = 0;
    var handleDepth = function(u) { i++; drawDM(pluginObj);drawIM(pluginObj); };
    if (pluginObj.attachEvent) {
      pluginObj.attachEvent("onNewFrame", handleDepth);
    } else {
      pluginObj.addEventListener("NewFrame", handleDepth, false);
    }
    pluginObj.requestStreams(true, true, false);

  }
function drawDM(plugin) {
    var dm = plugin.depthMap;
    if (dm.length == 0) return;
    var canv = document.getElementById('depth');
    var ctx = canv.getContext('2d');
    var pix = ctx.createImageData(160,120);
    var data = pix.data;
    var srcData = Base64.decode(dm);
    for(var i = 0; i < 160*120; i++) {
      data[i*4 + 1] = srcData[i*2];
      data[i*4 + 2] = srcData[i*2 + 1] << 3;
      data[i*4 + 3] = 255;
    }
    ctx.putImageData(pix, 0, 0);
  }
  function drawIM(plugin) {
    var im = plugin.imageMap;
    if (im.length == 0) return;
    var canv = document.getElementById('image');
    var ctx = canv.getContext('2d');
    var pix = ctx.createImageData(160,120);
    var data = pix.data;
    var srcData = Base64.decode(im);

    for(var i = 0; i < 160*120; i++) {
      data[i*4] = srcData[i*3];
      data[i*4 + 1] = srcData[i*3 + 1];
      data[i*4 + 2] = srcData[i*3 + 2];
      data[i*4 + 3] = 255;
    }
    ctx.putImageData(pix, 0, 0);
  }

var socket;
var host;

var currentRoomName = localStorage.getItem("currentRoomName");
if (null == currentRoomName) currentRoomName = "[ZigFu Demo]";  

function roomStarted(roomData) {
  host.on('goto', function(data) { goto(data); });
}

function loaded() {
    // connect to zigtv
  //socket = io.connect('http://zig.tv');
  socket = io.connect('http://'+document.location.hostname);
  socket.on('connect', function () {
    host = zigmote.host(socket);
    host.startRoom("motionosdemos", currentRoomName, roomStarted);
  });
}

document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);

</script>
</head>

<body>

<div id="wrapper">

<div id='header'>
    <div class='row'>
      <div class='left'>
        <a href="../index.html"><img src='../img/logo.png' alt='logo' /></a>
      </div>
      <div class='right'>
        <div style='float : right'>
          <h1 id="currentRoomName" onClick="nameentry();" class="nameentry">HTML Showcase</h1>

            <input class="nameentry" style="display:none; margin-top: 20px; " type="text" placeholder="[Enter TV Name]" spellcheck="off" 
            autocomplete="off" id="currentRoomNameInput" name="currentRoomNameInput" onChange="nameentrydone()"/>
        </div>
      </div>
    </div>
</div>

<div id="container">

	<div id="canvasCont">
    	
        <div id="depthCan"><canvas style="width:320px; height:240px;" id='depth' width='160' height='120'></canvas>
</div> 
    	
        <div id="imageCan"><canvas style="width:320px; height:240px;" id='image' width='160' height='120'></canvas>
</div>
    
    </div>
	
</div>
		
</div>
<div id="pluginContainer">
  <object id="ZigPlugin" type="application/x-zig" width="0" height="0">
    <param name="onload" value="ZigPluginLoaded" />
  </object>
</div> 
</body>
</html>
