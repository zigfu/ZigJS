<!DOCTYPE html>
<html>
<head>
<link href='http://fonts.googleapis.com/css?family=Istok+Web:400,400italic,700,700italic|Abel|Yellowtail' rel='stylesheet' type='text/css' />
<link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
<link href='css/style.css' rel='stylesheet' type='text/css' />

<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js' type='text/javascript'></script>

<script src="/socket.io/socket.io.js"></script>
<script src="js/synclist-client.js"></script>
<script src="js/zigmote-client.js"></script>
<script src="js/zigmote.cursor.js"></script>
<script src="goto.js"></script>

<!-- ZigJS -->
<script type="text/javascript" src="zig.js"></script>

<script type='text/javascript'>
images = [
	{
		'name': 'tube',
		'description' : 'Youtube Player',
		'default_image': 'img/youtube_but.png',
		'highlit_image': 'img/youtube_buthvr.png'
	}, 
	{
		'name': 'muse',
		'description' : 'Music Player',
		'default_image': 'img/muse_but.png',
		'highlit_image': 'img/muse_buthvr.png'
	}, 
	{
		'name': 'games',
		'description' : 'Sample Games',
		'default_image': 'img/games_but.png',
		'highlit_image': 'img/games_buthvr.png'
	}, 
	{
		'name': 'slid',
		'description' : 'Slide Viewer',
		'default_image': 'img/slide_but.png',
		'highlit_image': 'img/slide_buthvr.png'
	}
];

var currentRoomName = localStorage.getItem("currentRoomName");
if (null == currentRoomName) currentRoomName = "[ZigFu Demo]";	


var lastCursor = {x : 0, y : 0};

function clamp(val, min, max) {
	if (val < min) return min;
	if (val > max) return max;
	return val;
}


function moveCursorBy(element, deltaX, deltaY) {
	lastCursor.x = clamp(lastCursor.x + deltaX, 0, element.parentNode.offsetWidth);
	lastCursor.y = clamp(lastCursor.y + deltaY, 0, element.parentNode.offsetHeight);

	setCursor(element, lastCursor.x, lastCursor.y);
}


function setCursor(element, xpx, ypx) {
	element.style.left = xpx + "px";
	element.style.top = ypx + "px";
}

var cursorrel;

function roomStarted(roomData) {
	// TODO: bind user list

	var roomshared = synclist.subscribe(socket, roomData.roomsharedid);
	roomshared.set('hostpage', 'demos');

	// cursor stuff - TODO: Move boilerplate code to zigmote.cursor
	host.cursor.oncursorlock = function(userid) { onSessionStart();}
	host.cursor.oncursorunlock = function(userid) { onSessionEnd();}
	if (undefined !== host.cursor.locked) {
		host.cursor.oncursorlock(host.cursor.locked);
	}
	host.cursor.oncursor = (function(cursorElement) { return function(x,y,rel,userid) {
		cursorrel = rel;
		if (rel) {
			moveCursorBy(cursorElement, x, y);
		} else {
			horizontalFader.setValue(x);
		}
	}}) (document.getElementById("realcursor"));
	host.cursor.onclick = function(userid) {
		if (cursorrel) {
			var x = parseInt(document.getElementById("realcursor").style.left);
			var y =	parseInt(document.getElementById("realcursor").style.top);
			var elt = document.elementFromPoint(x,y-1); //subtract one to get the thing cursor points to
			var evt = document.createEvent("MouseEvents");
    		evt.initMouseEvent("click", true, true, window, 1, x, y, x, y,
        			false, false, false, false, 0, null);
			elt.dispatchEvent(evt);
		} else {
			pushDetector.onClick();			
		}
	}

	userslist = synclist.subscribe(socket, roomData.userslistid);
}

var socket;
var host;

$(document).ready( function () {
	lis = $('div.butholder ul li a');

	lis.each(function (index, element) {
		$(element).hover(function() { hoverEnter(index, element) },
						 function() { hoverLeave(index, element) });
	});

	nameChanged(currentRoomName);
	sliderNub = document.getElementById("slider_nub");
	renderInterval = setInterval(updateSlider, 1/60 * 1000)

	// connect to zigtv
	socket = io.connect('http://'+document.location.hostname);
	socket.on('connect', function () {
		// connected
		host = zigmote.host(socket);
		host.startRoom("motionosdemos", currentRoomName, roomStarted);

		host.on("slideNext", function(data) { console.log("Slide next"); });
		host.on("slidePrev", function(data) { console.log("Slide prev"); });
		host.on("slideFirst", function(data) { console.log("Slide first"); });
		host.on("slideLast", function(data) { console.log("Slide last"); });
		host.on('goto', function(data) { goto(data); });
	});

	socket.on('disconnect', function() {
		// disconnected
	});
});

function hoverEnter(index, element) {
	img = $(element).find('img');
	img.attr('src', images[index]['highlit_image']);
}

function hoverLeave(index, element) {
	img = $(element).find('img');
	img.attr('src', images[index]['default_image']);
}

function hoverLeaveAll(element) {
	for (var i=0; i<3; i++) {
		hoverLeave(i, lis.eq(i));
	}	
}
lastHighlighted = -1;

pushDetector = new Zig.PushDetector();
pushDetector.onClick = function() {
	console.log("Push detector: click " + lastHighlighted);
	if (lastHighlighted == -1) return;
	window.location = lis.eq(lastHighlighted).attr('href');
}

horizontalFader = new Zig.Fader(Zig.OrientationX, 300);
horizontalFader.itemsCount = 4;
horizontalFader.onItemSelected = function(itemIndex) {
	lastHighlighted = itemIndex;
	hoverEnter(itemIndex, lis.eq(itemIndex));
};

horizontalFader.onItemUnselected = function(itemIndex) {
	lastHighlighted = -1;
	hoverLeave(itemIndex, lis.eq(itemIndex));
};
horizontalFader.onValueChange = function(value)
{
	//element = document.getElementById("slider_nub");
	//element.style.left = (value * element.parentNode.offsetWidth - (element.offsetWidth / 2)) + "px";
	sliderTarget = value;
}

isInSession = false;
function onSessionStart()
{
	isInSession = true;
	$(".showinsession").fadeIn();
}

function onSessionEnd()
{
	isInSession = false;
	$(".showinsession").fadeOut();
	hoverLeaveAll();
} 

function ZigPluginLoaded() {
	Zig.init(document.getElementById("ZigPlugin"));
	Zig.SingleUser.controls.AddControl(horizontalFader);
	Zig.SingleUser.controls.AddControl(pushDetector);

	var radar = new Zig.TopDownUsersRadar(document.getElementById("usersRadar"), "user");
	Zig.SingleUser.onUserEngaged = function(user) { onSessionStart(); radar.DoUserEngaged(user); };
	Zig.SingleUser.onUserDisengaged = function(user) { onSessionEnd(); radar.DoUserDisengaged(user) };
	Zig.listeners.push(radar);

	document.getElementById('ver').innerHTML = document.getElementById("ZigPlugin").version ;
}

sliderTarget = 0.5;
sliderCurrent = 0.5;

function lerp(from, to, amount) 
{
	return from + ((to - from) * amount);
}

function updateSlider()
{
	if (!isInSession) return;
	
	sliderCurrent = lerp(sliderCurrent, sliderTarget, 0.5);
	sliderNub.style.left = (sliderCurrent * sliderNub.parentNode.offsetWidth - (sliderNub.offsetWidth / 2)) + "px";
}
/*---------------------------------------
PreLoader for Icons
---------------------------------------*/
function preloader() 
{
hoverImages = new Image(); 
hoverImages.src = "img/youtube_buthvr.png";
hoverImages.src = "img/muse_buthvr.png";
hoverImages.src = "img/games_buthvr.png";
hoverImages.src = "img/slide_buthvr.png";
}

function nameentry() {
    document.getElementById("currentRoomName").style.display = "none";
    document.getElementById("currentRoomNameInput").style.display = "block";
    document.getElementById("currentRoomNameInput").focus();
}

function nameentrydone() {
    var newName = document.getElementById("currentRoomNameInput").value;
    nameChanged(newName);
}

function nameChanged(newName) {
	if (newName == "") newName = "[NonameTV]";
    currentRoomName = newName;
    localStorage.setItem("currentRoomName", currentRoomName);
    document.getElementById("currentRoomNameInput").value = currentRoomName;
    document.getElementById("currentRoomName").innerHTML = currentRoomName;
    document.getElementById("currentRoomName").style.display = "block";
    document.getElementById("currentRoomNameInput").style.display = "none";
    if (undefined !== host) {
    	host.rename(currentRoomName);
    }
}
function MM_swapImgRestore() { //v3.0
  var i,x,a=document.MM_sr; for(i=0;a&&i<a.length&&(x=a[i])&&x.oSrc;i++) x.src=x.oSrc;
}
function MM_preloadImages() { //v3.0
  var d=document; if(d.images){ if(!d.MM_p) d.MM_p=new Array();
    var i,j=d.MM_p.length,a=MM_preloadImages.arguments; for(i=0; i<a.length; i++)
    if (a[i].indexOf("#")!=0){ d.MM_p[j]=new Image; d.MM_p[j++].src=a[i];}}
}

function MM_findObj(n, d) { //v4.01
  var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {
    d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}
  if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];
  for(i=0;!x&&d.layers&&i<d.layers.length;i++) x=MM_findObj(n,d.layers[i].document);
  if(!x && d.getElementById) x=d.getElementById(n); return x;
}

function MM_swapImage() { //v3.0
  var i,j=0,x,a=MM_swapImage.arguments; document.MM_sr=new Array; for(i=0;i<(a.length-2);i+=3)
   if ((x=MM_findObj(a[i]))!=null){document.MM_sr[j++]=x; if(!x.oSrc) x.oSrc=x.src; x.src=a[i+2];}
}
</script>

<style>

.slider {
	width: 940px;
	height: 15px;
	margin: 0px auto;
	background-color: #9ca6ac;
	border-radius: 3px;
	-moz-border-radius: 3px;
	-webkit-border-radius: 3px;
	box-shadow:inset 0px 1px 5px #000;
	-moz-box-shadow:inset 0px 1px 5px #000;
	-webkit-box-shadow:inset 0px 1px 5px #000;
	-o-box-shadow:inset 0px 1px 5px #000;
}

.slider_nub {
	width: 20px;
	height: 15px;
	background-color: #151b23;
	position: relative;
	border-radius: 3px;
	-moz-border-radius: 3px;
	-webkit-border-radius: 3px;
	box-shadow: 0px 1px 5px #000;
	-moz-box-shadow: 0px 1px 5px #000;
	-webkit-box-shadow: 0px 1px 5px #000;
	-o-box-shadow: 0px 1px 5px #000;
}

.showinsession {
	display: none
}

#usersRadar {
	width: 	300px;
	height: 300px;
	border-radius: 15px;
	margin-top: 100px;
	margin-left: 70%;
	background:url('img/radar.png'); 
	overflow:hidden;
	position: fixed;
}

#usersRadar .user {
	width:	35px;
	height: 35px;
	background-image: url(http://motionos.com/zigjs/beta/i/user_img_na.png);
	position:relative;
}

#usersRadar .user.active {
	background-image: url(http://motionos.com/zigjs/beta/i/user_img.png);
	position: relative;
}
#realcursor {
	width : 28px;
	height : 35px;
	position:absolute;
	background-image : url("i/hand-pointer.png");
}
</style>

<script>

var session = (function() {
	
	var isInSession;

	function lerp(from, to, amount) 
	{
		return from + ((to - from) * amount);
	}

	return {
		//start : start,
		//stop : stop,
		//select : select,
		isInSession : isInSession,
	}
})()

</script>

</head>

<body onLoad="javascript:preloader();MM_preloadImages('img/youtube_buthvr.png')">


<div id="wrapper">

	<div id="header">
		<div class="row">
			<div class="left">
				<img src="img/logo.png" alt='' />
			</div>
			<div class="right">
				<div style="float: right;">
					<h1 id="currentRoomName" onClick="nameentry();" class="nameentry">[Room Name]</h1>

    		<input class="nameentry" style="display:none; margin-top: 20px; " type="text" placeholder="[Enter TV Name]" spellcheck="off" 
    		autocomplete="off" id="currentRoomNameInput" name="currentRoomNameInput" onChange="nameentrydone()"/>
				</div>
			</div>
		</div>
	</div>
	
	<div id="gallery">
		<div class="butholder">
			<ul>
				<li><a href="youtubev2/index.html" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('youtube','','img/youtube_buthvr.png',1)"><img src="img/youtube_but.png" alt="Youtube Icon" name="youtube" width="240" height="249" border="0"></a></li>
				<li><a href="musicv3/host.html"><img name='muse' src='img/muse_but.png' alt='' /></a></li>
				<li><a href="jsnes/index.html"><img name='games' src='img/games_but.png' alt=''/></a></li>
				<li><a href="slideviewer/slides.html"><img name='slid' src='img/slide_but.png' alt='' /></a></li>
			</ul>
			<div style="height:15px">
				<div class="slider showinsession" id="slider">
					<div class="slider_nub showinsession" id="slider_nub"></div>
				</div>
		
        	</div>
        
         <div id="userConnected" style="display: none;">
         
             <p><span class="userConnectionName">[USER]</span>
             
             is connected...</p>
         
         </div> 
		
        </div>
	</div>
	
	<div id="content">
		<div id="usersRadar"></div>
	</div>
	
	<div id="footer">
       		<p>Zig.js ver - <span id="ver"><em>[ZigJS Not Installed]</em></span></p>
    		<center>
            
            <h3>POWERED <span class="footerType">BY</span></h3>
            <a href="http://zigfu.com"><img src="img/zigfulogo.png" height="57px" width="120px" /></a>
            <p>Copyright &copy;2012 Motion Arcade Inc.</p> 
            <p class="footP">All Rights Reserved</p>            
            
            
            </center>
		 
	</div>
	
</div>

<div id="pluginContainer">
	<object id="ZigPlugin" type="application/x-zig" width="0" height="0">
		<param name="onload" value="ZigPluginLoaded" />
	</object>
</div>

<div id="realcursor" class="showinsession">
</div>

</body>
</html>