<html>

<head>

<script src="js/iscroll.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/jquery.easing.1.2.js"></script>
<script src="js/jquery.anythingslider.min.js"></script>

<link href="css/anythingslider.css" rel="stylesheet">

<link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>

<link href='http://fonts.googleapis.com/css?family=Oleo+Script:400,700' rel='stylesheet' type='text/css'>

<link href='http://fonts.googleapis.com/css?family=Arimo:400,700' rel='stylesheet' type='text/css'>

<script src="../new/zig.js"></script>

<script>

if (!window.requestAnimationFrame) {
	window.requestAnimationFrame = (function() {
		return window.webkitRequestAnimationFrame ||
		window.mozRequestAnimationFrame ||
		window.oRequestAnimationFrame ||
		window.msRequestAnimationFrame ||
		function(callback, element) {
			window.setTimeout(callback, 1000 / 60);
		};
	})();
}

var iscrollController;

function setHeaderText(slider) {
	var txt = slider.$currentPage.attr("data-caption") || slider.currentPage;
	$("#headerlbl").text(txt);
}

function slideLoaded($slide) {
	if (undefined === $slide) return;

	// set caption text
	var txt = $slide.attr("data-caption") || $slide;
	$("#headerlbl").text(txt);

	// bind the iscoll associated with this slide
	var iscroll = $slide.children().eq(0).data('menu').iScroll;
	iscrollController.bindTo(iscroll);
}

function loaded() {
	zig.singleUserSession.startOnWave = false;
	zig.singleUserSession.startOnSteady = false;
	zig.singleUserSession.startOnExternalHandpoint = true;
	zig.singleUserSession.bboxBounds = [1200, 5000, 1000];
	zig.singleUserSession.bboxOffset = [0, 400, -400];


 	iscrollController = GestureableiScroll();
	zig.singleUserSession.addListener(iscrollController);

	$("#mainslider").anythingSlider({
		buildArrows : false,
		buildStartStop : false,
		buildNavigation : true,
		infiniteSlides	: false,
		expand  : false,
		hashTags : false,
		onInitialized : function(event, slider) { slideLoaded(slider.$currentPage); },
		onSlideComplete : function(slider) { slideLoaded(slider.$currentPage); },
		navigationFormatter : function(index, panel){
			return $(panel).attr('data-caption');
		},
		appendNavigationTo : "#mainviewer #breadcrumbs",
	});

	makeSearchMenu(searchkeywords);
	makeAMenu("Bryce", [123,234,345,456,567,678,789]);

}

document.addEventListener('DOMContentLoaded', setTimeout(loaded, 200), false);

function hysteresis(classname, pixelsize, container) {
  var cls = classname;
  var sizeFunction = (pixelsize == parseFloat(pixelsize)) ? function(currentItem){ return {x:pixelsize, y:pixelsize};} : pixelsize;
  var sizeX, sizeY;
  var items;
  var currentItem = null;

  if (undefined === container) {
    container = document.body;
  }

  function refreshItems(newcontainer) {
  	if (undefined !== newcontainer) {
  		container = newcontainer;
  	}
    items = document.getElementsByClassName(cls);
  }
  function start() {
    currentItem = null;
  }
  function stop() {
    if (currentItem) {
      currentItem.classList.remove("hovering");
    }
  }
  function inItem(item, x, y) {
    var rect = item.getBoundingClientRect();
    return (rect.left <= x) && (x <= rect.right) && (rect.top <= y) && (y <= rect.bottom);
  }
  function stillIn(item, x, y) {
    var rect = item.getBoundingClientRect();
    return ((rect.left-sizeX) <= x) && (x <= (rect.right+sizeX)) && ((rect.top-sizeY) <= y) && (y <= (rect.bottom+sizeY));
  }
  function updateNormalized(x,y) {
    update(container.offsetWidth * x, container.offsetHeight * y);
  }
  function update(x,y) {
  	var size = sizeFunction(currentItem);
  	sizeX = size.x; sizeY = size.y;
    //TODO: something similar to jQuery .offset() instead - this can probably
    //      break in some ways I don't know when using borders, padding and margins
    var rect = container.getBoundingClientRect();
    x += rect.left;
    y += rect.top;
    if (currentItem) {
      if (stillIn(currentItem, x, y)) return;
      // we left the current item
      //TODO: not special case
      currentItem.classList.remove("hovering");
      currentItem = null;
    }
    for (var i = 0; i < items.length; i++) {
      if (inItem(items[i], x, y)) {
        currentItem = items[i];
        currentItem.classList.add("hovering");
        break;
      }
    }
    api.currentItem = currentItem;
  }
  refreshItems();
  var api = {
	refreshItems : refreshItems,
	start : start,
	stop : stop,
	update : update,
	updateNormalized : updateNormalized,
	currentItem : currentItem,
   };
  return api;
}

function iscrollMouseMove(iscroll, x,y) {
  iscroll.handleEvent({
      type:"mousemove", 
      pageX : x, 
      pageY : y,
      });
}

function iscrollMouseDown(iscroll, x,y) {
  iscroll.handleEvent({
      type:"mousedown", 
      pageX : x, 
      pageY : y,
      button : 0,
      preventDefault : function() {} });
}

function iscrollMouseUp(iscroll, x,y) {
  iscroll.handleEvent({
      type:"mouseup", 
      pageX : x, 
      pageY : y,
      button : 0});
}

function GestureableiScroll() {
	var fader2d = zig.controls.Fader2D();
	var pd = zig.controls.PushDetector();
	var pushslider = zig.controls.Fader(zig.Orientation.Y, 400);
	var selectswipe = zig.controls.SwipeDetector();
	var h = hysteresis("hoverable", function(currentItem) {return {x:20, y:20};});
	var boundiScroll = null;

	// these are both normalized
	var currCursor = [0,0];
	var targetCursor = [0,0];

	var childControls = [
		fader2d,
		pd,
		pushslider,
	];

	var inSession = false;

	var api = {
		onattach : onattach,
		ondetach : ondetach,
		onsessionstart : onsessionstart,
		onsessionend : onsessionend,
		bindTo : bindTo,
	}

	function bindTo(iscroll) {
		boundiScroll = iscroll;
		h.refreshItems(iscroll.wrapper);
	}

	function lerp(from, to, amount) {
		return from + ((to - from) * amount);
	}

	function frame() {
		if (!inSession) return;
		
		// update current cursor position
		currCursor[0] = lerp(currCursor[0], targetCursor[0], 0.5);
		currCursor[1] = lerp(currCursor[1], targetCursor[1], 0.5);

		// propegate to DOM if not pushed
		if (!pd.isPushed) {
			// always use x=0.5 for vertical menu
			h.updateNormalized(0.5/*currCursor[0]*/, currCursor[1]);
		} else {
			var val = (pushslider.value * 2) - 1;
			// scale for feel
			val *= 0.6;
			iscrollMouseMove(boundiScroll, 0.5 * boundiScroll.wrapperW, (0.5 + val) * boundiScroll.wrapperH);
		}
		
		requestAnimationFrame(frame);
	}

	// event handlers

	pd.addEventListener('push', function() {
		$(".pushable").addClass("pushed");
		$(".hidewhenpushed").fadeOut(300);
		h.stop();
		pushslider.moveTo(pd.pushPosition, 0.5);
		iscrollMouseDown(boundiScroll, 0.5 * boundiScroll.wrapperW, 0.5 * boundiScroll.wrapperH);
	});

	pd.addEventListener('release', function() {
		$(".pushable").removeClass("pushed");
		if (inSession) {
			$(".hidewhenpushed").fadeIn(300);
			h.start();
		}
		iscrollMouseUp(boundiScroll, 0.5 * boundiScroll.wrapperW, 0.5 * boundiScroll.wrapperH);
	});

	pd.addEventListener('click', function() {
		
	});

	selectswipe.addEventListener('swipeleft', function() {
		// back
	});

	selectswipe.addEventListener('swiperight', function() {
		// select
	});

	fader2d.addEventListener('valuechange', function() {
		// flip y axis to match screen coords
		targetCursor[0] = fader2d.value[0];
		targetCursor[1] = 1 - fader2d.value[1];
	});

	pushslider.addEventListener("edge", function(val) {
		pd.release();
	});

	function onattach(sessiondetector) {
		childControls.forEach(function(control) {
			sessiondetector.addListener(control);
		});
	}

	function ondetach(sessiondetector) {
		childControls.forEach(function(control) {
			sessiondetector.removeListener(control);
		});
	}

	function onsessionstart(focusPosition) {
		console.log("Session started");
		inSession = true;
		h.start();
		frame();
		$(".showInSession").show();
	}

	function onsessionend() {
		console.log("Session ended");
		// this will stop the frame() loop
		inSession = false;
		h.stop();
		$(".showInSession").hide();
	}

	return api;
}

</script>

<script>

var searchkeywords = [
	'Zigfu',
	'Monkeys',
	'Salad',
	'Thailand',
	'Paper cup',
	'Splume',
	'Burning man',
	'Sublime Text',
	"O'mercy",
	'Zigfu',
	'Monkeys',
	'Salad',
	'Thailand',
	'Paper cup',
	'Splume',
	'Burning man',
	'Sublime Text',
	"O'mercy",
	'Zigfu',
	'Monkeys',
	'Salad',
	'Thailand',
	'Paper cup',
	'Splume',
	'Burning man',
	'Sublime Text',
	"O'mercy",
];

function addToSlider(child, caption) {
	var c = $("<li>")
		.attr("data-caption", caption)
		.append(child)
	$("#mainslider")
		.append(c)
		.anythingSlider();

	if ($("#mainslider").data('AnythingSlider').pages == 1) {
		// first page, callback doesn't get called. lets do it manually
		slideLoaded($("#mainslider").data('AnythingSlider').$currentPage);
	} else {
		$("#mainslider").anythingSlider($("#mainslider").data('AnythingSlider').pages);
	}
}

function doBack() {
	var currentPage = $("#mainslider").data('AnythingSlider').currentPage;
	if (currentPage > 1) {
		$("#mainslider").anythingSlider(currentPage-1, function(slider) {
			$("#mainslider li.panel:not(.cloned)").last().remove();
		});
	}
}

function makeMenu(cls) {
	if (undefined === cls) {
		cls = "nicelist";
	}

	var innerlist = $("<ul>");
	var menu = $("<div>")
		.append($("<div>").append(innerlist))
		.addClass(cls);

	var is = new iScroll(menu.get(0))

	menu.data('menu', {
		iScroll : is,
		addChild : function (text, action) {
		  	innerlist.append($("<li>")
				.addClass("hoverable")
				.text(text)
				.click(action)
			);
		},
		refresh : function() {
			setTimeout(function () {
				is.refresh();
			}, 0);}
	});

	return menu.get(0);
}

function makeAMenu(caption, items) {
	var m = makeMenu();
	items.forEach(function(item){
		$(m).data('menu').addChild(item, (function(i){ return function(){console.log(i);};})(item));
	});
	$(m).data('menu').refresh();
	
	addToSlider(m, caption);
}

function makeSearchMenu(items) {
	var m = makeMenu();
	items.forEach(function(item){
		$(m).data('menu').addChild(item, (function(i){ return function(){doImageSearch(i);};})(item));
	});
	$(m).data('menu').refresh();
	
	addToSlider(m, "Search for images");
}

function doImageSearch(item) {
	console.log("Searching for images: " + item);
}

</script>


<style>
body {
	background: #33706a; /* Old browsers */
background: -moz-radial-gradient(center, ellipse cover,  #33706a 0%, #1a364f 100%); /* FF3.6+ */
background: -webkit-gradient(radial, center center, 0px, center center, 100%, color-stop(0%,#33706a), color-stop(100%,#1a364f)); /* Chrome,Safari4+ */
background: -webkit-radial-gradient(top, ellipse cover,  #33706a 0%,#1a364f 100%); /* Chrome10+,Safari5.1+ */
background: -o-radial-gradient(center, ellipse cover,  #33706a 0%,#1a364f 100%); /* Opera 12+ */
background: -ms-radial-gradient(center, ellipse cover,  #33706a 0%,#1a364f 100%); /* IE10+ */
background: radial-gradient(center, ellipse cover,  #33706a 0%,#1a364f 100%); /* W3C */
filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#33706a', endColorstr='#1a364f',GradientType=1 ); /* IE6-9 fallback on horizontal gradient */
}
.viewer {
	margin: auto;
	width : 50%;
	border : solid 1px rgba(255,255,255,0.4);
	background-color: rgba(255,255,255,0.2);
	position: relative;
	border-radius: 8px;
	box-shadow: inset 0px -1px 5px rgba(255,255,255,0.3), 0px -1px 5px rgba(0,0,0,0.5);
	transition : all 0.2s ease-in-out;
	-webkit-transition: all 0.2s ease-in-out;
    -moz-transition: all 0.2s ease-in-out;
    -o-transition: all 0.2s ease-in-out;
    -ms-transition: all 0.2s ease-in-out;
}

.viewer.pushed {
	-webkit-transform: scale(0.95);
}
.viewer .header {
	top:0; left:0;
	width:100%;
	height:45px;
	border-top-right-radius: 8px;
	border-top-left-radius: 8px;
	font-family: 'Oleo Script';
	font-weight: 400;
	line-height:45px;
	background-color: rgba(255,255,255,0.3);
	padding:0;
	color:#FFF;
	font-size: 2em;
	text-shadow: 0px 0px 5px rgba(0,0,0,0.3);
	text-align:center;
}

.viewer .header.pushed {
	background-color: rgba(255,255,255,0.7);
	-webkit-transition: background-color .15s ease-in-out .15s;
}
.nicelist {
	display:block;
	height : 100%;
	overflow:hidden;
	position:relative;
}
.nicelist ul {
	list-style:none;
	padding:0;
	margin:0;
	width:100%;
	text-align:left;
	border-bottom-right-radius: 8px;
	border-bottom-left-radius: 8px;
}
.nicelist li {
	padding:0 10px;
	height:80px;
	line-height:80px;
	color: #FFF;
	width: 100%;
	text-shadow: 0.5px 1px 0px rgba(0,0,0,0.5);
	font-family: 'Arimo';
	font-weight: 700;
	border-bottom:1px solid rgba(0,0,0,0.5);
	border-top:1px solid rgba(255,255,255,0.3);
	font-size:34px;
	overflow: hidden;
}
.nicelist li.hovering {
	background-color: rgba(76,174,164,0.7);
}
.nicelist li:hover {
	background-color: rgba(76,174,164,0.7);
}

.viewer .contents {
	width : 100%;
	height : 500px;
	border-bottom-right-radius: 8px;
	border-bottom-left-radius: 8px;
}

.anythingsliderlist {
	width : 100%;
	height : 100%;
}

#buttons {
	position: absolute;
	width: 125%;
	height: 100px;
	margin: 0 auto;
	z-index: 0;
	top: 225px;
	right: -120px;
}
#leftBut {
	width: 100px;
	height: 100px;
	float: left;
	background-color: rgba(255,0,0,0.5);
}
#rightBut {
	width: 100px;
	height: 100px;
	float: right;
	background-color: rgba(255,0,0,0.5);
}

.showInSession {
	display: none;
}

#mainviewer {
	top : 150px;
}
.thumbNav {
	list-style-type: none;
}
.thumbNav li {
	border-radius: 6px;
	background-color: rgba(255,255,255,0.3);
	margin-right: 10px;
	padding: 5px;
	font-family: Arial;
	display: inline;
}
.thumbNav li a {
	text-decoration: none;
	color: #FFF;
}
.thumbNav li a:hover {
	color: #000;
	text-decoration: none;
}
</style>

</head>

<body>

	<div id="mainviewer" class="viewer pushable">

			<div id="breadcrumbs"></div>

			<div id="buttons" class="showInSession hidewhenpushed">

				<a href=""><div id="leftBut"></div></a>

				<a href=""><div id="rightBut"></div></a>

			</div>

		<div class="header pushable"><span id="headerlbl">Header</span></div>

		<div class="contents">


			<ul id="mainslider" class="anythingsliderlist">
				
			</ul>

		</div>

	</div>

</body>

</html>