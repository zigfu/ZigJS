<html>

<head>

<script src="js/iscroll.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/jquery.easing.1.2.js"></script>
<script src="js/jquery.anythingslider.min.js"></script>

<link href="css/anythingslider.css" rel="stylesheet">

<link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>

<link href='http://fonts.googleapis.com/css?family=Oleo+Script:400,700' rel='stylesheet' type='text/css'>

<link href='http://fonts.googleapis.com/css?family=Arimo:400,700' rel='stylesheet' type='text/css'>

<script src="../new/zig.js"></script>

<script>

if (!window.requestAnimationFrame) {
	window.requestAnimationFrame = (function() {
		return window.webkitRequestAnimationFrame ||
		window.mozRequestAnimationFrame ||
		window.oRequestAnimationFrame ||
		window.msRequestAnimationFrame ||
		function(callback, element) {
			window.setTimeout(callback, 1000 / 60);
		};
	})();
}

var theiscroll1;
var theiscroll2;
var theiscroll3;

var iscrollController;// = GestureableiScroll();

var iscrollLookup = {};

function setHeaderText(slider) {
	var txt = slider.$currentPage.attr("data-caption") || slider.currentPage;
	$("#headerlbl").text(txt);
}

function slideLoaded($slide) {

	if (undefined === $slide) return;

	// set caption text
	var txt = $slide.attr("data-caption") || $slide;
	$("#headerlbl").text(txt);

	// bind the iscoll associated with this slide
	var iscroll = iscrollLookup[$slide.children().eq(0).attr("id")] ||
		$slide.children().eq(0).data('menu').iScroll;
	iscrollController.bindTo(iscroll);
}

function loaded() {
	zig.singleUserSession.startOnWave = false;
	zig.singleUserSession.startOnSteady = false;
	zig.singleUserSession.startOnExternalHandpoint = true;

 	iscrollController = GestureableiScroll();
	zig.singleUserSession.addListener(iscrollController);

	/*
	theiscroll1 = new iScroll("iscrollme1");
	theiscroll2 = new iScroll("iscrollme2");
	theiscroll3 = new iScroll("iscrollme3");

	iscrollLookup = {
		iscrollme1 : theiscroll1,
		iscrollme2 : theiscroll2,
		iscrollme3 : theiscroll3,
	};*/

	$("#mainslider").anythingSlider({
		buildArrows : false,
		buildStartStop : false,
		buildNavigation : false,
		infiniteSlides	: false,
		expand  : false,
		hashTags : false,
		onInitialized : function(event, slider) { slideLoaded(slider.$currentPage); },
		onSlideComplete : function(slider) { slideLoaded(slider.$currentPage); },
	});

	makeSearchMenu(searchkeywords);

}

document.addEventListener('DOMContentLoaded', setTimeout(loaded, 200), false);

function hysteresis(classname, pixelsize, container) {
  var cls = classname;
  var sizeFunction = (pixelsize == parseFloat(pixelsize)) ? function(currentItem){ return {x:pixelsize, y:pixelsize};} : pixelsize;
  var sizeX, sizeY;
  var items;
  var currentItem = null;

  if (undefined === container) {
    container = document.body;
  }

  function refreshItems(newcontainer) {
  	if (undefined !== newcontainer) {
  		container = newcontainer;
  	}
    items = document.getElementsByClassName(cls);
  }
  function start() {
    currentItem = null;
  }
  function stop() {
    if (currentItem) {
      currentItem.classList.remove("hovering");
    }
  }
  function inItem(item, x, y) {
    var rect = item.getBoundingClientRect();
    return (rect.left <= x) && (x <= rect.right) && (rect.top <= y) && (y <= rect.bottom);
  }
  function stillIn(item, x, y) {
    var rect = item.getBoundingClientRect();
    return ((rect.left-sizeX) <= x) && (x <= (rect.right+sizeX)) && ((rect.top-sizeY) <= y) && (y <= (rect.bottom+sizeY));
  }
  function updateNormalized(x,y) {
    update(container.offsetWidth * x, container.offsetHeight * y);
  }
  function update(x,y) {
  	var size = sizeFunction(currentItem);
  	sizeX = size.x; sizeY = size.y;
    //TODO: something similar to jQuery .offset() instead - this can probably
    //      break in some ways I don't know when using borders, padding and margins
    var rect = container.getBoundingClientRect();
    x += rect.left;
    y += rect.top;
    if (currentItem) {
      if (stillIn(currentItem, x, y)) return;
      // we left the current item
      //TODO: not special case
      currentItem.classList.remove("hovering");
      currentItem = null;
    }
    for (var i = 0; i < items.length; i++) {
      if (inItem(items[i], x, y)) {
        currentItem = items[i];
        currentItem.classList.add("hovering");
        break;
      }
    }
    api.currentItem = currentItem;
  }
  refreshItems();
  var api = {
	refreshItems : refreshItems,
	start : start,
	stop : stop,
	update : update,
	updateNormalized : updateNormalized,
	currentItem : currentItem,
   };
  return api;
}

function iscrollMouseMove(iscroll, x,y) {
  iscroll.handleEvent({
      type:"mousemove", 
      pageX : x, 
      pageY : y,
      });
}

function iscrollMouseDown(iscroll, x,y) {
  iscroll.handleEvent({
      type:"mousedown", 
      pageX : x, 
      pageY : y,
      button : 0,
      preventDefault : function() {} });
}

function iscrollMouseUp(iscroll, x,y) {
  iscroll.handleEvent({
      type:"mouseup", 
      pageX : x, 
      pageY : y,
      button : 0});
}

function GestureableiScroll() {
	var fader2d = zig.controls.Fader2D();
	var pd = zig.controls.PushDetector();
	var pushslider = zig.controls.Fader(zig.Orientation.Y, 400);
	var selectswipe = zig.controls.SwipeDetector();
	var h = hysteresis("hoverable", function(currentItem) {return {x:20, y:20};});
	var boundiScroll = null;

	// these are both normalized
	var currCursor = [0,0];
	var targetCursor = [0,0];

	var childControls = [
		fader2d,
		pd,
		pushslider,
	];

	var inSession = false;

	var pointHistory = [];
	var pointsToSave = 60;
	var velocityTime = 100; // 300 ms lower bound
	var deceleration = 0.0006;

	var api = {
		onattach : onattach,
		ondetach : ondetach,
		onsessionstart : onsessionstart,
		onsessionend : onsessionend,
		bindTo : bindTo,
	}

	function bindTo(iscroll) {
		boundiScroll = iscroll;
		h.refreshItems(iscroll.wrapper);
	}

	function lerp(from, to, amount) {
		return from + ((to - from) * amount);
	}

	function frame() {
		if (!inSession) return;
		
		// update current cursor position
		currCursor[0] = lerp(currCursor[0], targetCursor[0], 0.5);
		currCursor[1] = lerp(currCursor[1], targetCursor[1], 0.5);

		// propegate to DOM if not pushed
		if (!pd.isPushed) {
			// always use x=0.5 for vertical menu
			h.updateNormalized(0.5/*currCursor[0]*/, currCursor[1]);
		} else {
			var val = (pushslider.value * 2) - 1;

			// save point for velocity calculation
			pointHistory.push([val, (+new Date())]);
			while (pointHistory.length > pointsToSave) {
				pointHistory.shift();
			}

			// scale for feel
			val *= 0.6;

			iscrollMouseMove(boundiScroll, 0.5 * boundiScroll.wrapperW, (0.5 + val) * boundiScroll.wrapperH);
		}
		
		requestAnimationFrame(frame);
	}

	// event handlers

	pd.addEventListener('push', function() {
		$(".pushable").addClass("pushed");
		h.stop();

		pushslider.moveTo(pd.pushPosition, 0.5);

		// reset point buffer
		pointHistory = [];

		iscrollMouseDown(boundiScroll, 0.5 * boundiScroll.wrapperW, 0.5 * boundiScroll.wrapperH);
	});

	pd.addEventListener('release', function() {
		$(".pushable").removeClass("pushed");
		h.start();

		iscrollMouseUp(boundiScroll, 0.5 * boundiScroll.wrapperW, 0.5 * boundiScroll.wrapperH);

		//do velocity calculation
/*
		var endPoint = pointHistory[pointHistory.length - 1];
		var endTime = endPoint[1],
			endValue = endPoint[0];
		for (var i = pointHistory.length - 2; i >= 0; i--) {
			var pt = pointHistory[i];
			var dt = endTime - pt[1];
			if (dt > velocityTime) {
				// dt is big enough for reliable velocity calculation
				var velocity = (endValue - pt[0]) / dt;
				console.log('velocity is: ' + velocity);
				var sign = velocity < 0 ? 1 : -1;
				velocity = Math.abs(velocity);
				// calculate speed in pixels
				// then use v(t)= v0 + a*t to find the time when the
				// motion will stop (v(t) = 0 => t = v0/a)
				// and then stick that into x(t) = x0 + v0*t + 0.5*a*(t^2)
				// (we're using constant deceleration for great justice)
				var time = velocity / deceleration,
					distance = (velocity*velocity) / deceleration;
				

				//console.log("pixelVelocity: " + pixelInitialVelocity);
				//console.log("motion time: " + time);
				//console.log("total distance: " + distance);
				var scrollData = boundiScroll._momentum(velocity*boundiScroll.wrapperH, 1, -boundiScroll.y, (boundiScroll.maxScrollY < 0 ? boundiScroll.scrollerH - boundiScroll.wrapperH + boundiScroll.y - boundiScroll.minScrollY : 0), boundiScroll.wrapperH);
				boundiScroll.scrollTo(0, scrollData.dist * sign, scrollData.time, true);

				break;
			}
		}
		console.log('final dt:' + dt);
		console.log(pointHistory);*/
	});

	pd.addEventListener('click', function() {
		
	});

	selectswipe.addEventListener('swipeleft', function() {
		// back
	});

	selectswipe.addEventListener('swiperight', function() {
		// select
	});

	fader2d.addEventListener('valuechange', function() {
		// flip y axis to match screen coords
		targetCursor[0] = fader2d.value[0];
		targetCursor[1] = 1 - fader2d.value[1];
	});

	pushslider.addEventListener("edge", function(val) {
		pd.release();
	});

	function onattach(sessiondetector) {
		childControls.forEach(function(control) {
			sessiondetector.addListener(control);
		});
	}

	function ondetach(sessiondetector) {
		childControls.forEach(function(control) {
			sessiondetector.removeListener(control);
		});
	}

	function onsessionstart(focusPosition) {
		console.log("Session started");
		inSession = true;
		h.start();
		frame();
		$(".showInSession").show();
	}

	function onsessionend() {
		console.log("Session ended");
		// this will stop the frame() loop
		inSession = false;
		h.stop();
		$(".showInSession").hide();
	}

	return api;
}

</script>

<script>

var searchkeywords = [
	'Zigfu',
	'Monkeys',
	'Salad',
	'Thailand',
	'Paper cup',
	'Splume',
	'Burning man',
	'Sublime Text',
	"O'mercy",
	'Zigfu',
	'Monkeys',
	'Salad',
	'Thailand',
	'Paper cup',
	'Splume',
	'Burning man',
	'Sublime Text',
	"O'mercy",
	'Zigfu',
	'Monkeys',
	'Salad',
	'Thailand',
	'Paper cup',
	'Splume',
	'Burning man',
	'Sublime Text',
	"O'mercy",
];

function addToSlider(child, caption) {
	var c = $("<li>")
		.attr("data-caption", caption)
		.append(child)
	$("#mainslider")
		.append(c)
		.anythingSlider();

	$("#mainslider").anythingSlider($("#mainslider").data('AnythingSlider').pages);
}

function doBack() {
	var currentPage = $("#mainslider").data('AnythingSlider').currentPage;
	if (currentPage > 1) {
		$("#mainslider").anythingSlider(currentPage-1, function(slider) {
			$("#mainslider li.panel:not(.cloned)").last().remove();
		});
	}
}

function makeMenu(cls) {
	if (undefined === cls) {
		cls = "nicelist";
	}

	var innerlist = $("<ul>");
	var menu = $("<div>")
		.append($("<div>").append(innerlist))
		.addClass(cls);

	var is = new iScroll(menu.get(0))

	menu.data('menu', {
		iScroll : is,
		addChild : function (text, action) {
		  	innerlist.append($("<li>")
				.addClass("hoverable")
				.text(text)
				.click(action)
			);
		},
		refresh : function() {
			setTimeout(function () {
				is.refresh();
			}, 0);}
	});

	return menu.get(0);
}

function makeSearchMenu(items) {
	var m = makeMenu();
	items.forEach(function(item){
		$(m).data('menu').addChild(item, (function(i){ return function(){doImageSearch(i);};})(item));
	});
	$(m).data('menu').refresh();
	
	addToSlider(m, "Search for images");
}

function doImageSearch(item) {
	console.log("Searching for images: " + item);
}

function navigateToMenu(menu) {
	
}

</script>


<style>
body {
	background: #33706a; /* Old browsers */
background: -moz-radial-gradient(center, ellipse cover,  #33706a 0%, #1a364f 100%); /* FF3.6+ */
background: -webkit-gradient(radial, center center, 0px, center center, 100%, color-stop(0%,#33706a), color-stop(100%,#1a364f)); /* Chrome,Safari4+ */
background: -webkit-radial-gradient(top, ellipse cover,  #33706a 0%,#1a364f 100%); /* Chrome10+,Safari5.1+ */
background: -o-radial-gradient(center, ellipse cover,  #33706a 0%,#1a364f 100%); /* Opera 12+ */
background: -ms-radial-gradient(center, ellipse cover,  #33706a 0%,#1a364f 100%); /* IE10+ */
background: radial-gradient(center, ellipse cover,  #33706a 0%,#1a364f 100%); /* W3C */
filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#33706a', endColorstr='#1a364f',GradientType=1 ); /* IE6-9 fallback on horizontal gradient */
}
.viewer {
	margin: auto;
	width : 50%;
	border : solid 1px rgba(255,255,255,0.4);
	background-color: rgba(255,255,255,0.2);
	position: relative;
	border-radius: 8px;
	box-shadow: inset 0px -1px 5px rgba(255,255,255,0.3), 0px -1px 5px rgba(0,0,0,0.5);
	transition : all 0.2s ease-in-out;
	-webkit-transition: all 0.2s ease-in-out;
    -moz-transition: all 0.2s ease-in-out;
    -o-transition: all 0.2s ease-in-out;
    -ms-transition: all 0.2s ease-in-out;
}
.viewer.pushed {
	-webkit-transform: scale(0.95);
	border: solid 1px rgba(255,255,255,0.3);
}
.viewer .header {
	top:0; left:0;
	width:100%;
	height:45px;
	border-top-right-radius: 8px;
	border-top-left-radius: 8px;
	font-family: 'Oleo Script';
	font-weight: 400;
	line-height:45px;
	background-color: rgba(255,255,255,0.3);
	padding:0;
	color:#FFF;
	font-size: 2em;
	text-shadow: 0px 0px 5px rgba(0,0,0,0.3);
	text-align:center;
}
.viewer .header.pushed {
	background-color: rgba(255,255,255,0.7);
	-webkit-transition: background-color .15s ease-in-out .15s;
}
.nicelist {
	display:block;
	height : 100%;
	overflow:hidden;
	position:relative;
}
.nicelist ul {
	list-style:none;
	padding:0;
	margin:0;
	width:100%;
	text-align:left;
	border-bottom-right-radius: 8px;
	border-bottom-left-radius: 8px;
}
.nicelist li {
	padding:0 10px;
	height:80px;
	line-height:80px;
	color: #FFF;
	width: 100%;
	text-shadow: 0.5px 1px 0px rgba(0,0,0,0.5);
	font-family: 'Arimo';
	font-weight: 700;
	border-bottom:1px solid rgba(0,0,0,0.5);
	border-top:1px solid rgba(255,255,255,0.3);
	font-size:34px;
	overflow: hidden;
}
.nicelist li.hovering {
	background-color: rgba(76,174,164,0.7);
	-webkit-transition: background-color .05s linear .05s;
}
.viewer .contents {
	width : 100%;
	height : 500px;
	border-bottom-right-radius: 8px;
	border-bottom-left-radius: 8px;
}

.anythingsliderlist {
	width : 100%;
	height : 100%;
}
/*#caption {
	width: 50%;
	height: 100px;
	margin: 0 auto;
	border-radius: 8px;
	margin-bottom: 50px;
	background-color: rgba(0,0,0,0.5);
}*/
#buttons {
	position: absolute;
	width: 125%;
	height: 100px;
	margin: 0 auto;
	z-index: 0;
	top: 225px;
	right: -120px;
}
#leftBut {
	width: 100px;
	height: 100px;
	float: left;
	background-color: rgba(255,0,0,0.5);
}
#rightBut {
	width: 100px;
	height: 100px;
	float: right;
	background-color: rgba(255,0,0,0.5);
}

.showInSession {
	display: none;
}
</style>

</head>

<body>

	<div id="mainviewer" class="viewer pushable">

			<div id="buttons" class="showInSession">

				<a href=""><div id="leftBut"></div></a>

				<a href=""><div id="rightBut"></div></a>

			</div>

		<div class="header pushable"><span id="headerlbl">Header</span></div>

		<div class="contents">


			<ul id="mainslider" class="anythingsliderlist">
				<!--
				<li data-caption="This is the caption for panel 1">
					<div id="iscrollme1" class="nicelist">
						<div>
							<ul>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
								<li class="hoverable">Moshe 1</li>
							</ul>
						</div>
					</div>
				</li>

				<li data-caption="test2">
					<div id="iscrollme2" class="nicelist">
						<div>
							<ul>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>
								<li class="hoverable">ksjdhf 1</li>

							</ul>
						</div>
					</div>
				</li>

				<li data-caption="test3">
					<div id="iscrollme3" class="nicelist">
						<div>
							<ul>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
								<li class="hoverable">Yitzchak 1</li>
							</ul>
						</div>
					</div>
				</li>
				-->
			</ul>

		</div>

	</div>

</body>

</html>